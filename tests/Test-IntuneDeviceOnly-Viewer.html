<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Intune Device Only Viewer</title>
  <style>
    :root {
      --bg: #f4f6f8;
      --panel: #ffffff;
      --ink: #1d232a;
      --muted: #66717d;
      --line: #d9e0e6;
      --ok: #0f9d58;
      --warn: #b26a00;
      --bad: #c62828;
      --accent: #005a9c;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(180deg, #eef3f7 0%, #f7f9fb 100%);
      color: var(--ink);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .hero {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.04);
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .muted { color: var(--muted); }
    .drop {
      border: 2px dashed #9fb6cc;
      border-radius: 12px;
      padding: 18px;
      background: #fbfdff;
      display: grid;
      gap: 10px;
      justify-items: start;
    }
    .drop.drag { background: #eef7ff; border-color: var(--accent); }
    input[type="file"] { display: none; }
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-bottom: 14px;
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
    }
    .span-4 { grid-column: span 4; }
    .span-6 { grid-column: span 6; }
    .span-12 { grid-column: span 12; }
    .metric { font-size: 26px; font-weight: 700; line-height: 1.1; }
    .label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    th { font-size: 12px; color: var(--muted); text-transform: uppercase; }
    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 700;
    }
    .pill.ok { background: #e7f6ee; color: #156f43; }
    .pill.bad { background: #fdecec; color: #9b2020; }
    .pill.warn { background: #fff2db; color: #8a5600; }
    .kv { display: grid; grid-template-columns: 220px 1fr; gap: 6px 10px; font-size: 13px; }
    .kv div:nth-child(odd) { color: var(--muted); }
    details {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      margin-top: 10px;
    }
    summary {
      cursor: pointer;
      padding: 10px 12px;
      font-weight: 600;
    }
    pre {
      margin: 0;
      padding: 12px;
      overflow: auto;
      font-size: 12px;
      background: #0f1720;
      color: #dbe7f3;
      border-top: 1px solid var(--line);
      border-radius: 0 0 10px 10px;
      max-height: 360px;
    }
    .hidden { display: none; }
    @media (max-width: 900px) {
      .span-4, .span-6 { grid-column: span 12; }
      .kv { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Intune Device Only Viewer</h1>
      <div class="muted">Load an <code>IntuneDeviceOnly_*.json</code> file generated by <code>tests/Test-IntuneDeviceOnly.ps1</code>.</div>
      <div id="drop" class="drop" style="margin-top:12px;">
        <label class="btn" for="fileInput">Choose JSON File</label>
        <input id="fileInput" type="file" accept=".json,application/json">
        <div class="muted">Or drag and drop the summary JSON here.</div>
        <div id="fileName" class="muted"></div>
      </div>
    </div>

    <div id="content" class="hidden">
      <div class="grid">
        <div class="card span-4">
          <div class="label">Device</div>
          <div id="mDevice" class="metric">-</div>
          <div id="mCollected" class="muted"></div>
        </div>
        <div class="card span-4">
          <div class="label">Endpoint Captures</div>
          <div id="mEndpoints" class="metric">0</div>
          <div id="mEndpointBreakdown" class="muted"></div>
        </div>
        <div class="card span-4">
          <div class="label">Report Exports</div>
          <div id="mReports" class="metric">0</div>
          <div id="mReportBreakdown" class="muted"></div>
        </div>
      </div>

      <div class="card span-12" style="margin-bottom:14px;">
        <h3 style="margin-top:0;">Resolved IDs</h3>
        <div id="resolvedIds" class="kv"></div>
      </div>

      <div class="card span-12" style="margin-bottom:14px;">
        <h3 style="margin-top:0;">Endpoint Captures</h3>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Count</th>
              <th>URI</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody id="endpointRows"></tbody>
        </table>
      </div>

      <div class="card span-12" style="margin-bottom:14px;">
        <h3 style="margin-top:0;">Report Exports</h3>
        <table>
          <thead>
            <tr>
              <th>Report</th>
              <th>Status</th>
              <th>Rows</th>
              <th>Filter</th>
              <th>File</th>
              <th>Error</th>
            </tr>
          </thead>
          <tbody id="reportRows"></tbody>
        </table>
      </div>

      <div class="card span-12">
        <h3 style="margin-top:0;">Raw Payloads (from summary JSON)</h3>
        <div id="rawPayloads"></div>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const drop = document.getElementById('drop');
    const fileNameEl = document.getElementById('fileName');
    const content = document.getElementById('content');

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (file) loadFile(file);
    });

    ['dragenter', 'dragover'].forEach(evt => drop.addEventListener(evt, (e) => {
      e.preventDefault();
      drop.classList.add('drag');
    }));
    ['dragleave', 'drop'].forEach(evt => drop.addEventListener(evt, (e) => {
      e.preventDefault();
      drop.classList.remove('drag');
    }));
    drop.addEventListener('drop', (e) => {
      const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (file) loadFile(file);
    });

    function esc(s) {
      return String(s ?? '').replace(/[&<>"]/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
    }

    async function loadFile(file) {
      fileNameEl.textContent = `Loaded: ${file.name}`;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        render(data);
      } catch (err) {
        alert(`Failed to load JSON: ${err.message}`);
      }
    }

    function pill(ok, warnText) {
      if (ok === true) return '<span class="pill ok">Success</span>';
      if (ok === false) return '<span class="pill bad">Failed</span>';
      return `<span class="pill warn">${esc(warnText || 'N/A')}</span>`;
    }

    function render(data) {
      content.classList.remove('hidden');

      const captures = Array.isArray(data.endpointCaptures) ? data.endpointCaptures : [];
      const reports = Array.isArray(data.reportExports) ? data.reportExports : [];
      const capOk = captures.filter(c => c && c.success).length;
      const repOk = reports.filter(r => r && r.success).length;

      document.getElementById('mDevice').textContent = data.deviceName || '(unknown)';
      document.getElementById('mCollected').textContent = data.collectedAt || '';
      document.getElementById('mEndpoints').textContent = String(captures.length);
      document.getElementById('mEndpointBreakdown').textContent = `${capOk} succeeded, ${captures.length - capOk} failed`;
      document.getElementById('mReports').textContent = String(reports.length);
      document.getElementById('mReportBreakdown').textContent = reports.length ? `${repOk} succeeded, ${reports.length - repOk} failed` : 'No reports exported';

      const resolved = data.resolvedIds || {};
      const resolvedEl = document.getElementById('resolvedIds');
      resolvedEl.innerHTML = '';
      Object.keys(resolved).forEach(k => {
        const v = resolved[k] == null || resolved[k] === '' ? 'NOT RESOLVED' : resolved[k];
        resolvedEl.insertAdjacentHTML('beforeend', `<div>${esc(k)}</div><div><code>${esc(v)}</code></div>`);
      });

      const endpointRows = document.getElementById('endpointRows');
      endpointRows.innerHTML = captures.map(c => `
        <tr>
          <td>${esc(c.name)}</td>
          <td>${pill(c.success)}</td>
          <td>${esc(c.count ?? '')}</td>
          <td><code>${esc(c.uri)}</code></td>
          <td>${c.error ? `<code>${esc(c.error)}</code>` : ''}</td>
        </tr>
      `).join('');

      const reportRows = document.getElementById('reportRows');
      reportRows.innerHTML = reports.length ? reports.map(r => `
        <tr>
          <td>${esc(r.reportName)}</td>
          <td>${pill(r.success)}</td>
          <td>${esc(r.rowCount ?? '')}</td>
          <td><code>${esc(r.filter || '')}</code></td>
          <td>${r.filePath ? `<code>${esc(r.filePath)}</code>` : ''}</td>
          <td>${r.error ? `<code>${esc(r.error)}</code>` : ''}</td>
        </tr>
      `).join('') : '<tr><td colspan="6" class="muted">No report export results in this file.</td></tr>';

      const raw = document.getElementById('rawPayloads');
      raw.innerHTML = '';
      captures.forEach((c, idx) => {
        const payload = c && Object.prototype.hasOwnProperty.call(c, 'data') ? c.data : null;
        raw.insertAdjacentHTML('beforeend', `
          <details ${idx < 2 ? 'open' : ''}>
            <summary>${esc(c.name)} ${pill(c.success)}</summary>
            <pre>${esc(JSON.stringify(payload, null, 2))}</pre>
          </details>
        `);
      });
    }
  </script>
</body>
</html>

