<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' cdn.sheetjs.com; connect-src 'self' cdn.sheetjs.com;">
    <title>DeviceDNA Report Viewer</title>
    <style>
:root {
    --color-success: #28a745;
    --color-warning: #ffc107;
    --color-danger: #dc3545;
    --color-info: #007bff;
    --color-muted: #6c757d;
    --color-bg: #ffffff;
    --color-bg-alt: #f8f9fa;
    --color-bg-dark: #343a40;
    --color-text: #212529;
    --color-text-muted: #6c757d;
    --color-border: #dee2e6;
    --color-header-bg: #e9ecef;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-lg: 0 4px 8px rgba(0,0,0,0.15);
    --radius: 6px;
    --radius-lg: 10px;
    --transition: 0.2s ease;
}

[data-theme="dark"] {
    --color-bg: #1a1a2e;
    --color-bg-alt: #16213e;
    --color-bg-dark: #0f0f1a;
    --color-text: #e8e8e8;
    --color-text-muted: #adb5bd;
    --color-border: #404040;
    --color-header-bg: #252545;
}

*, *::before, *::after {
    box-sizing: border-box;
}

html {
    font-size: 14px;
    scroll-behavior: smooth;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.6;
    color: var(--color-text);
    background-color: var(--color-bg);
    margin: 0;
    padding: 0;
    transition: background-color var(--transition), color var(--transition);
}

/* Accessibility - Screen reader only */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Sticky Navigation Bar */
.sticky-nav {
    position: sticky;
    top: 0;
    z-index: 1000;
    background: var(--color-bg);
    border-bottom: 2px solid var(--color-border);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

[data-theme="dark"] .sticky-nav {
    background: var(--color-bg-dark);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.nav-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

.nav-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
    gap: 20px;
}

.nav-brand {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-text);
    text-decoration: none;
    white-space: nowrap;
}

.nav-brand-icon {
    font-size: 1.5rem;
}

.nav-search {
    flex: 1;
    max-width: 500px;
    position: relative;
}

.nav-search input {
    width: 100%;
    padding: 8px 15px 8px 35px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 0.9rem;
    background: var(--color-bg-alt);
    color: var(--color-text);
    transition: all var(--transition);
}

.nav-search input:focus {
    outline: none;
    border-color: var(--color-info);
    background: var(--color-bg);
    box-shadow: 0 0 0 3px rgba(0,123,255,0.15);
}

.nav-search::before {
    content: '\1F50D';
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.5;
    font-size: 0.9rem;
}

.nav-filters {
    display: flex;
    gap: 8px;
}

.filter-btn {
    padding: 6px 12px;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    color: var(--color-text);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all var(--transition);
    white-space: nowrap;
}

.filter-btn:hover {
    background: var(--color-bg-alt);
    border-color: var(--color-info);
}

.filter-btn.active {
    background: var(--color-info);
    color: white;
    border-color: var(--color-info);
}

.filter-btn.filter-issues.active {
    background: var(--color-danger);
    border-color: var(--color-danger);
}

.filter-btn.filter-warnings.active {
    background: var(--color-warning);
    border-color: var(--color-warning);
    color: #856404;
}

.mobile-menu-toggle {
    display: none;
    background: transparent;
    border: 1px solid var(--color-border);
    padding: 8px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1.25rem;
}

.nav-links {
    display: flex;
    gap: 5px;
    padding: 8px 0;
    border-top: 1px solid var(--color-border);
    overflow-x: auto;
}

.nav-link {
    padding: 8px 16px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-text);
    text-decoration: none;
    transition: all var(--transition);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
    position: relative;
}

.nav-link:hover {
    background: var(--color-bg-alt);
    color: var(--color-info);
}

.nav-link.active {
    background: var(--color-info);
    color: white;
}

.nav-link-icon {
    font-size: 1rem;
}

.nav-link-count {
    background: rgba(0,123,255,0.2);
    color: var(--color-info);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.nav-link.active .nav-link-count {
    background: rgba(255,255,255,0.25);
    color: white;
}

.nav-link-status {
    margin-left: 4px;
    font-size: 0.75rem;
}

.nav-submenu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    min-width: 200px;
    margin-top: 4px;
    z-index: 1001;
}

[data-theme="dark"] .nav-submenu {
    background: var(--color-bg-dark);
}

.nav-link:hover .nav-submenu,
.nav-submenu:hover {
    display: block;
}

.nav-submenu-item {
    padding: 10px 16px;
    cursor: pointer;
    transition: background-color var(--transition);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}

.nav-submenu-item:first-child {
    border-top-left-radius: var(--radius);
    border-top-right-radius: var(--radius);
}

.nav-submenu-item:last-child {
    border-bottom-left-radius: var(--radius);
    border-bottom-right-radius: var(--radius);
}

.nav-submenu-item:hover {
    background: var(--color-bg-alt);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .mobile-menu-toggle {
        display: block;
    }

    .nav-top {
        flex-wrap: wrap;
    }

    .nav-search {
        order: 3;
        flex: 1 1 100%;
        max-width: none;
    }

    .nav-filters {
        flex-wrap: wrap;
    }

    .filter-btn {
        font-size: 0.75rem;
        padding: 4px 8px;
    }

    .nav-links {
        display: none;
        flex-direction: column;
        gap: 2px;
    }

    .nav-links.mobile-open {
        display: flex;
    }

    .nav-submenu {
        position: static;
        display: none;
        border: none;
        box-shadow: none;
        padding-left: 20px;
        margin-top: 0;
    }

    .nav-link.submenu-open .nav-submenu {
        display: block;
    }

    .nav-link:hover .nav-submenu {
        display: none;
    }
}

/* Layout */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

/* Header */
.header {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    color: white;
    padding: 30px;
    margin-bottom: 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
}

[data-theme="dark"] .header {
    background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
}

.header-title-container {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 10px;
}

/* Logo styles removed - using emoji instead */

.header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 600;
}

.header-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.header-info-item {
    background: rgba(255,255,255,0.15);
    padding: 12px 16px;
    border-radius: var(--radius);
    backdrop-filter: blur(5px);
}

.header-info-item label {
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.8;
    margin-bottom: 4px;
}

.header-info-item span {
    font-weight: 500;
    font-size: 1rem;
}

/* Toolbar */
.toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    padding: 15px;
    background: var(--color-bg-alt);
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
}

.search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
}

.search-box input {
    width: 100%;
    padding: 10px 15px 10px 40px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 1rem;
    background: var(--color-bg);
    color: var(--color-text);
    transition: border-color var(--transition), box-shadow var(--transition);
}

.search-box input:focus {
    outline: none;
    border-color: var(--color-info);
    box-shadow: 0 0 0 3px rgba(0,123,255,0.15);
}

.search-box::before {
    content: '\1F50D';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.5;
    font-size: 1rem;
}

.btn-group {
    display: flex;
    gap: 5px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn-primary {
    background: var(--color-info);
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--color-bg);
    color: var(--color-text);
    border: 1px solid var(--color-border);
}

.btn-secondary:hover {
    background: var(--color-bg-alt);
}

.btn-success {
    background: var(--color-success);
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-warning {
    background: var(--color-warning);
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
}

/* Dark mode toggle */
.theme-toggle {
    background: transparent;
    border: 1px solid var(--color-border);
    padding: 8px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 1.1rem;
    transition: all var(--transition);
}

.theme-toggle:hover {
    background: var(--color-bg-alt);
}

/* Sections */
.section {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-left: 4px solid var(--color-border);
    border-radius: var(--radius-lg);
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: box-shadow var(--transition), border-color var(--transition);
}

/* Domain color accents */
.section[data-domain="gp"] { border-left-color: #2563EB; }
.section[data-domain="intune"] { border-left-color: #7C3AED; }
.section[data-domain="sccm"] { border-left-color: #0D9488; }
.section[data-domain="wu"] { border-left-color: #EA580C; }
.section[data-domain="device"] { border-left-color: #64748B; }
.section[data-domain="issues"] { border-left-color: var(--color-warning); }

.section-header {
    background: var(--color-header-bg);
    padding: 15px 20px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    user-select: none;
    transition: background-color var(--transition);
}

.section-header:hover {
    background: var(--color-border);
}

.section-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header .toggle-icon {
    font-size: 1.2rem;
    transition: transform var(--transition);
}

.section.collapsed .toggle-icon {
    transform: rotate(-90deg);
}

.section-content {
    padding: 20px;
    transition: max-height 0.3s ease-out, opacity 0.2s ease;
}

.section.collapsed .section-content {
    display: none;
}

.section-count {
    background: var(--color-info);
    color: white;
    padding: 2px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Alert boxes */
.alert {
    padding: 15px 20px;
    border-radius: var(--radius);
    margin-bottom: 15px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.alert-warning {
    background: rgba(255, 193, 7, 0.15);
    border: 1px solid var(--color-warning);
    color: #856404;
}

[data-theme="dark"] .alert-warning {
    color: #ffc107;
}

.alert-danger {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid var(--color-danger);
    color: #721c24;
}

[data-theme="dark"] .alert-danger {
    color: #f8d7da;
}

.alert-info {
    background: rgba(0, 123, 255, 0.1);
    border: 1px solid var(--color-info);
    color: #004085;
}

[data-theme="dark"] .alert-info {
    color: #b8daff;
}

.alert-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
}

/* Device/WU/SCCM info grid layout */
.device-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin: 10px 0;
}

.info-group {
    background: var(--color-bg-alt);
    border-radius: var(--radius);
    padding: 15px;
    border: 1px solid var(--color-border);
}

.info-group h3 {
    margin: 0 0 12px 0;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--color-text-muted);
    padding-bottom: 8px;
    border-bottom: 1px solid var(--color-border);
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 6px 0;
    gap: 12px;
    border-bottom: 1px solid rgba(0,0,0,0.04);
}

.info-row:last-child {
    border-bottom: none;
}

[data-theme="dark"] .info-row {
    border-bottom-color: rgba(255,255,255,0.04);
}

[data-theme="dark"] .info-row:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: var(--color-text-muted);
    font-size: 0.85rem;
    white-space: nowrap;
    flex-shrink: 0;
}

.info-value {
    text-align: right;
    word-break: break-word;
    color: var(--color-text);
}

/* Setting description subtitle (WU policy table) */
.setting-desc {
    display: inline-block;
    font-size: 0.8rem;
    color: var(--color-text-muted);
    font-weight: 400;
    line-height: 1.3;
    margin-top: 2px;
}

/* Tables */
.table-container {
    overflow-x: auto;
    margin: 10px 0;
}

.table-search {
    margin-bottom: 10px;
}

.table-search input {
    padding: 8px 12px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 0.875rem;
    background: var(--color-bg);
    color: var(--color-text);
    width: 250px;
    max-width: 100%;
}

table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 0.9rem;
}

thead th {
    background: var(--color-header-bg);
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
    cursor: pointer;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
}

thead th:hover {
    background: var(--color-border);
}

thead th.sorted-asc::after {
    content: ' \25B2';
    font-size: 0.7rem;
}

thead th.sorted-desc::after {
    content: ' \25BC';
    font-size: 0.7rem;
}

tbody tr {
    border-bottom: 1px solid var(--color-border);
    transition: background-color var(--transition);
}

tbody tr:nth-child(even) {
    background: var(--color-bg-alt);
}

tbody tr:hover {
    background: rgba(0, 123, 255, 0.05);
}

tbody td {
    padding: 12px 15px;
    vertical-align: top;
    word-break: break-word;
    overflow-wrap: break-word;
}

/* Expandable rows */
.expandable-row {
    cursor: pointer;
}

.expandable-row td:first-child::before {
    content: '\25B6';
    margin-right: 8px;
    font-size: 0.7rem;
    transition: transform var(--transition);
    display: inline-block;
}

.expandable-row.expanded td:first-child::before {
    transform: rotate(90deg);
}

.detail-row {
    display: none;
    background: var(--color-bg-alt);
}

.detail-row.visible {
    display: table-row;
}

.detail-content {
    padding: 20px;
    background: var(--color-bg);
    border-left: 4px solid var(--color-info);
    margin: 10px;
    border-radius: var(--radius);
}

/* Settings sub-table inside detail rows */
.settings-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
    margin-top: 8px;
}
.settings-table th {
    text-align: left;
    padding: 6px 10px;
    font-weight: 600;
    border-bottom: 2px solid var(--color-border);
    color: var(--color-text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.settings-table td {
    padding: 5px 10px;
    border-bottom: 1px solid var(--color-border);
    vertical-align: top;
}
.settings-table td.setting-value {
    max-width: 500px;
    overflow-wrap: break-word;
    word-break: break-all;
}
.settings-count {
    font-size: 0.75rem;
    color: var(--color-text-secondary);
    font-weight: normal;
    margin-left: 6px;
}

/* Status badges */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.badge-success {
    background: rgba(40, 167, 69, 0.15);
    color: var(--color-success);
}

.badge-warning {
    background: rgba(255, 193, 7, 0.2);
    color: #856404;
}

[data-theme="dark"] .badge-warning {
    color: #ffc107;
}

.badge-danger {
    background: rgba(220, 53, 69, 0.15);
    color: var(--color-danger);
}

.badge-info {
    background: rgba(0, 123, 255, 0.15);
    color: var(--color-info);
}

.badge-muted {
    background: rgba(108, 117, 125, 0.15);
    color: var(--color-muted);
}

/* Copy button */
.copy-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 2px 6px;
    font-size: 0.8rem;
    opacity: 0.5;
    transition: opacity var(--transition);
    border-radius: var(--radius);
}

.copy-btn:hover {
    opacity: 1;
    background: var(--color-bg-alt);
}

.copy-btn.copied {
    color: var(--color-success);
}

/* Value display */
.value-with-copy {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.value-truncate {
    max-width: 300px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Key-value pairs */
.kv-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 10px;
}

.kv-item {
    display: flex;
    gap: 10px;
    padding: 8px 12px;
    background: var(--color-bg-alt);
    border-radius: var(--radius);
}

.kv-item .key {
    font-weight: 600;
    color: var(--color-text-muted);
    min-width: 120px;
}

.kv-item .value {
    word-break: break-word;
}

/* Settings list in detail rows */
.settings-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.settings-list li {
    padding: 8px 0;
    border-bottom: 1px solid var(--color-border);
    display: flex;
    justify-content: space-between;
    gap: 20px;
}

.settings-list li:last-child {
    border-bottom: none;
}

.setting-name {
    font-weight: 500;
}

.setting-value {
    color: var(--color-text-muted);
    text-align: right;
}

/* Subsection */
.subsection {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid var(--color-border);
}

.subsection h3 {
    margin: 0 0 15px 0;
    font-size: 1.1rem;
    color: var(--color-text-muted);
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--color-text-muted);
}

.empty-state-icon {
    font-size: 3rem;
    opacity: 0.3;
    margin-bottom: 10px;
}

/* Footer */
.footer {
    text-align: center;
    padding: 20px;
    color: var(--color-text-muted);
    font-size: 0.85rem;
    border-top: 1px solid var(--color-border);
    margin-top: 30px;
}

/* Export dropdown */
.export-dropdown {
    position: relative;
    display: inline-block;
}

.export-dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    top: 100%;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    min-width: 160px;
    z-index: 100;
    margin-top: 5px;
}

.export-dropdown.open .export-dropdown-content {
    display: block;
}

.export-dropdown-content button {
    display: block;
    width: 100%;
    padding: 10px 15px;
    border: none;
    background: none;
    text-align: left;
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--color-text);
    transition: background-color var(--transition);
}

.export-dropdown-content button:hover {
    background: var(--color-bg-alt);
}

.export-dropdown-content button:first-child {
    border-radius: var(--radius) var(--radius) 0 0;
}

.export-dropdown-content button:last-child {
    border-radius: 0 0 var(--radius) var(--radius);
}

/* Loading indicator */
.loading {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.loading::after {
    content: '';
    width: 14px;
    height: 14px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-info);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Print styles */
/* ===== ACCESSIBILITY ===== */

/* Focus indicators for keyboard navigation */
*:focus {
    outline: 2px solid var(--color-info);
    outline-offset: 2px;
}

button:focus, a:focus, input:focus, select:focus {
    outline: 2px solid var(--color-info);
    outline-offset: 2px;
}

/* High contrast mode support */
@media (prefers-contrast: high) {
    :root {
        --color-border: #000000;
        --color-text: #000000;
        --color-bg: #ffffff;
    }

    [data-theme="dark"] {
        --color-border: #ffffff;
        --color-text: #ffffff;
        --color-bg: #000000;
    }

    .btn {
        border: 2px solid currentColor !important;
    }

    .badge {
        border: 2px solid currentColor !important;
    }
}

/* Reduced motion support for users with vestibular disorders */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
    }
}

/* ===== PRINT STYLES ===== */

@media print {
    /* Reset all elements to print-friendly colors */
    * {
        background: transparent !important;
        color: #000 !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    body {
        background: white !important;
        color: black !important;
        font-size: 10pt;
        line-height: 1.4;
        margin: 0;
        padding: 0;
    }

    /* Hide all interactive UI elements */
    .toolbar,
    .theme-toggle,
    .export-dropdown,
    .copy-btn,
    .btn,
    .search-box,
    .btn-group,
    .toggle-icon,
    .expandable-row td:first-child::before,
    .sticky-nav,
    .nav-container,
    .nav-menu,
    .nav-actions,
    .print-btn,
    .table-controls,
    .filter-btn {
        display: none !important;
    }

    /* Preserve header with brand colors */
    .header {
        background: #1e3c72 !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        page-break-after: avoid;
        padding: 15pt !important;
        margin-bottom: 10pt !important;
    }

    .header h1 {
        font-size: 18pt !important;
        color: white !important;
    }

    /* Logo styles removed - using emoji instead */

    .header-info-item {
        background: rgba(255,255,255,0.2) !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .header-info-item label,
    .header-info-item span {
        color: white !important;
    }

    /* Section handling with page breaks */
    .section {
        page-break-inside: avoid;
        border: 1pt solid #000 !important;
        margin-bottom: 10pt;
        box-shadow: none !important;
    }

    /* Force all collapsed sections to expand */
    .section.collapsed .section-content {
        display: block !important;
    }

    .section-header {
        background: #f0f0f0 !important;
        border-bottom: 1pt solid #000 !important;
        padding: 8pt !important;
        page-break-after: avoid;
    }

    .section-header h2 {
        font-size: 12pt !important;
    }

    .section-content {
        padding: 10pt !important;
    }

    /* Expand all detail rows for comprehensive printing */
    .detail-row {
        display: table-row !important;
    }

    .detail-content {
        border-left: 2pt solid #000 !important;
        background: #f9f9f9 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    /* Table printing optimizations */
    table {
        border-collapse: collapse !important;
        width: 100%;
        font-size: 9pt;
    }

    /* Ensure table headers repeat on each page */
    thead {
        display: table-header-group;
    }

    tbody {
        display: table-row-group;
    }

    thead th {
        background: #e0e0e0 !important;
        border: 1pt solid #000 !important;
        padding: 6pt !important;
        font-weight: bold;
        text-align: left;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    tbody tr {
        page-break-inside: avoid;
        border-bottom: 1pt solid #ccc !important;
    }

    tbody td {
        border: 1pt solid #ddd !important;
        padding: 6pt !important;
    }

    /* Preserve badge colors with visible borders */
    .badge {
        border: 1pt solid currentColor !important;
        padding: 2pt 6pt !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .badge-success {
        background: #e8f5e9 !important;
        color: #2e7d32 !important;
    }

    .badge-warning {
        background: #fff3e0 !important;
        color: #ef6c00 !important;
    }

    .badge-danger {
        background: #ffebee !important;
        color: #c62828 !important;
    }

    .badge-info {
        background: #e3f2fd !important;
        color: #1565c0 !important;
    }

    /* Alert boxes */
    .alert {
        border: 1pt solid #000 !important;
        padding: 8pt !important;
        page-break-inside: avoid;
    }

    /* Link handling - show URLs in print */
    a {
        text-decoration: underline;
        color: #000 !important;
    }

    a[href^="http"]::after {
        content: " (" attr(href) ")";
        font-size: 8pt;
        font-style: italic;
    }

    /* Footer */
    .footer {
        page-break-before: avoid;
        border-top: 1pt solid #000 !important;
        padding: 10pt 0 !important;
        margin-top: 20pt;
    }

    /* Prevent page breaks after headings */
    h1, h2, h3 {
        page-break-after: avoid;
    }

    /* Hide decorative elements */
    .empty-state-icon {
        display: none;
    }
}

/* ===== PRINT BUTTON ===== */

.print-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--color-info);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    cursor: pointer;
    font-weight: 600;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all var(--transition);
}

.print-btn:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

@media print {
    .print-btn {
        display: none !important;
    }
}

/* ===== RESPONSIVE BREAKPOINTS ===== */

/* Tablet (768px - 1199px) - 2 column grid */
@media (min-width: 768px) and (max-width: 1199px) {
    .container {
        max-width: 100%;
        padding: 15px;
    }

    .header h1 {
        font-size: 1.75rem;
    }

    .header-info {
        grid-template-columns: repeat(2, 1fr);
    }

    .kv-list {
        grid-template-columns: repeat(2, 1fr);
    }

    table {
        font-size: 0.85rem;
    }

    /* Hide less critical table columns on tablet */
    .hide-tablet {
        display: none;
    }
}

/* Mobile (<768px) - 1 column stack */
@media (max-width: 767px) {
    html {
        font-size: 13px;
    }

    .container {
        padding: 10px;
    }

    .header {
        padding: 15px;
        margin-bottom: 15px;
    }

    .header h1 {
        font-size: 1.5rem;
    }

    /* Logo styles removed - using emoji instead */

    .header-title-container {
        gap: 12px;
    }

    .header-info {
        grid-template-columns: 1fr;
        gap: 10px;
    }

    .header-info-item {
        padding: 10px 12px;
    }

    /* Toolbar mobile layout */
    .toolbar {
        flex-direction: column;
        align-items: stretch;
        padding: 12px;
        gap: 8px;
    }

    .search-box {
        min-width: 100%;
    }

    .btn-group {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
    }

    .btn {
        padding: 10px 14px;
        font-size: 0.9rem;
    }

    /* Section adjustments */
    .section {
        margin-bottom: 15px;
    }

    .section-header {
        padding: 12px 15px;
    }

    .section-header h2 {
        font-size: 1.1rem;
    }

    .section-content {
        padding: 15px;
    }

    /* Mobile-friendly tables with horizontal scroll */
    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        font-size: 0.8rem;
        min-width: 600px; /* Force horizontal scroll instead of squashing */
    }

    thead th,
    tbody td {
        padding: 8px 10px;
    }

    /* Hide non-critical columns on mobile */
    .hide-mobile {
        display: none;
    }

    /* Card-style layout for key-value pairs */
    .kv-list {
        grid-template-columns: 1fr;
    }

    .kv-item {
        flex-direction: column;
        gap: 5px;
    }

    .kv-item .key {
        min-width: auto;
        font-size: 0.85rem;
    }

    /* Alert mobile */
    .alert {
        padding: 12px 15px;
        font-size: 0.9rem;
    }

    /* Settings list mobile */
    .settings-list li {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    .setting-value {
        text-align: left;
    }

    /* Detail rows */
    .detail-content {
        padding: 15px;
        margin: 5px;
    }

    /* Footer */
    .footer {
        font-size: 0.8rem;
        padding: 15px 10px;
    }

    /* Value truncation on mobile */
    .value-truncate {
        max-width: 200px;
    }

    /* Print button mobile position */
    .print-btn {
        bottom: 15px;
        right: 15px;
        padding: 10px 16px;
        font-size: 0.9rem;
    }

    /* Sticky nav mobile (if present) */
    .sticky-nav {
        margin-bottom: 15px;
    }

    .nav-container {
        padding: 0 10px;
    }

    .nav-top {
        flex-wrap: wrap;
        padding: 10px 0;
        gap: 10px;
    }

    .nav-brand {
        font-size: 1.1rem;
    }

    /* Collapse navigation menu on mobile */
    .nav-menu {
        display: none;
    }

    .nav-menu.open {
        display: flex;
    }
}

/* Desktop Large (1200px+) - 4 column grid */
@media (min-width: 1200px) {
    .container {
        max-width: 1400px;
    }

    .header-info {
        grid-template-columns: repeat(4, 1fr);
    }

    .kv-list {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Desktop Extra Large (1600px+) - expanded grid */
@media (min-width: 1600px) {
    .container {
        max-width: 1600px;
    }

    .header-info {
        grid-template-columns: repeat(5, 1fr);
    }

    .kv-list {
        grid-template-columns: repeat(3, 1fr);
    }
}

/* Mobile landscape orientation */
@media (max-width: 767px) and (orientation: landscape) {
    .header {
        padding: 12px 15px;
    }

    .header-info {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* ===== TOUCH DEVICE OPTIMIZATIONS ===== */

@media (hover: none) and (pointer: coarse) {
    /* Larger tap targets for touch - minimum 44x44px (Apple HIG) */
    .btn {
        min-height: 44px;
        padding: 12px 18px;
    }

    .section-header {
        min-height: 50px;
        padding: 15px 20px;
    }

    thead th {
        padding: 15px;
    }

    .expandable-row {
        min-height: 44px;
    }

    /* Remove hover effects on touch devices */
    .btn:hover,
    .section-header:hover,
    thead th:hover,
    tbody tr:hover {
        transform: none;
    }
}

/* ===== TABLE ENHANCEMENTS ===== */

/* Status icon column */
.status-icon-col {
    width: 40px;
    text-align: center;
    padding: 8px !important;
    padding-left: 12px !important; /* 8px base + 4px border compensation */
    font-size: 1.2rem;
}

.status-icon-cell {
    text-align: center;
    padding: 12px 8px !important;
}

.status-icon {
    font-size: 1.3rem;
    line-height: 1;
    display: inline-block;
}

.status-icon.error { color: var(--color-danger); }
.status-icon.warning { color: var(--color-warning); }
.status-icon.success { color: var(--color-success); }
.status-icon.neutral { color: var(--color-muted); }

/* Color-coded row borders — applied to first cell to avoid column misalignment with border-collapse */
table tbody td:first-child {
    border-left: 4px solid transparent;
    transition: border-left-color var(--transition);
}

/* Compensate for 4px border in tables without status icon column */
table thead th:first-child:not(.status-icon-col) {
    padding-left: 19px; /* 15px base + 4px border compensation */
}

table tbody tr.group-header-row {
    background-color: var(--color-header-bg);
}
table tbody tr.group-header-row td:first-child {
    border-left-color: transparent;
}
table tbody tr.group-header-row td {
    padding: 10px 16px 6px;
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--color-text-secondary);
}

table tbody tr[data-status-category="error"] td:first-child {
    border-left-color: var(--color-danger);
}

table tbody tr[data-status-category="warning"] td:first-child {
    border-left-color: var(--color-warning);
}

table tbody tr[data-status-category="success"] td:first-child {
    border-left-color: var(--color-success);
}

table tbody tr[data-status-category="neutral"] td:first-child {
    border-left-color: var(--color-border);
}

/* Detail rows inherit parent border color */
tr.expandable-row[data-status-category="error"] + tr.detail-row td:first-child {
    border-left-color: var(--color-danger);
}

tr.expandable-row[data-status-category="warning"] + tr.detail-row td:first-child {
    border-left-color: var(--color-warning);
}

tr.expandable-row[data-status-category="success"] + tr.detail-row td:first-child {
    border-left-color: var(--color-success);
}

tr.expandable-row[data-status-category="neutral"] + tr.detail-row td:first-child {
    border-left-color: var(--color-border);
}

/* Larger badge sizing */
.badge {
    padding: 5px 12px;
    font-size: 0.85rem;
    font-weight: 700;
    min-width: 90px;
    text-align: center;
    justify-content: center;
}

/* Section header enhancements */
.section-header-main {
    display: flex;
    align-items: center;
    gap: 20px;
    flex: 1;
}

.section-status-counts {
    display: flex;
    gap: 12px;
    align-items: center;
    font-size: 0.9rem;
}

.status-count {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    border-radius: var(--radius);
    background: var(--color-bg-alt);
    font-weight: 600;
    opacity: 0.8;
}

.status-count[data-count="0"] { opacity: 0.3; }
.status-count.error { color: var(--color-danger); }
.status-count.warning { color: var(--color-warning); }
.status-count.success { color: var(--color-success); }

/* Table controls layout */
.table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

.table-filters {
    display: flex;
    gap: 8px;
}

.filter-btn {
    padding: 8px 16px;
    border: 1px solid var(--color-border);
    background: var(--color-bg);
    color: var(--color-text);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all var(--transition);
}

.filter-btn:hover {
    background: var(--color-bg-alt);
}

.filter-btn.active {
    background: var(--color-info);
    color: white;
    border-color: var(--color-info);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .section-header-main {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .table-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .filter-btn {
        flex: 1;
    }
}

/* Dark theme adjustments */
[data-theme="dark"] .status-count {
    background: var(--color-bg-dark);
}

[data-theme="dark"] .filter-btn {
    background: var(--color-bg-dark);
}

/* ===== ISSUE SUMMARY SECTION ===== */

.issue-summary {
    margin: 2rem 0;
    background: var(--color-bg);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.issue-summary-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #ffffff;
    border-bottom: 3px solid rgba(255, 255, 255, 0.2);
}

.issue-summary-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.issue-summary-header .summary-count {
    font-size: 0.875rem;
    opacity: 0.9;
    margin-top: 0.5rem;
}

.issue-summary-body {
    padding: 1.5rem;
}

.issue-empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--color-success);
    font-size: 1.125rem;
    font-weight: 500;
}

.issue-empty-state::before {
    content: "✓";
    display: block;
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--color-success);
}

.issue-category {
    margin-bottom: 1.5rem;
}

.issue-category:last-child {
    margin-bottom: 0;
}

.issue-category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.25rem;
    background: var(--color-bg-alt);
    border: 2px solid var(--color-border);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}

.issue-category-header:hover {
    background: var(--color-bg);
    border-color: var(--color-muted);
}

.issue-category-header.critical {
    background: #fef2f2;
    border-color: #fecaca;
}

.issue-category-header.critical:hover {
    background: #fee2e2;
    border-color: #fca5a5;
}

.issue-category-header.warning {
    background: #fffbeb;
    border-color: #fde68a;
}

.issue-category-header.warning:hover {
    background: #fef3c7;
    border-color: #fcd34d;
}

[data-theme="dark"] .issue-category-header.critical {
    background: rgba(220, 38, 38, 0.1);
    border-color: rgba(220, 38, 38, 0.3);
}

[data-theme="dark"] .issue-category-header.warning {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
}

.issue-category-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
    font-size: 1rem;
}

.issue-category-title .icon {
    font-size: 1.25rem;
}

.issue-category-count {
    display: inline-block;
    min-width: 1.5rem;
    height: 1.5rem;
    line-height: 1.5rem;
    text-align: center;
    background: var(--color-bg);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    padding: 0 0.5rem;
}

.issue-category-header.critical .issue-category-count {
    background: var(--color-danger);
    color: white;
}

.issue-category-header.warning .issue-category-count {
    background: var(--color-warning);
    color: white;
}

.issue-category-toggle {
    font-size: 0.875rem;
    color: var(--color-muted);
    transition: transform 0.2s ease;
}

.issue-category-header.collapsed .issue-category-toggle {
    transform: rotate(-90deg);
}

.issue-category-items {
    margin-top: 0.75rem;
    display: none;
}

.issue-category-header:not(.collapsed) + .issue-category-items {
    display: block;
}

.issue-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    margin-bottom: 0.75rem;
    transition: all 0.15s ease;
}

.issue-item:last-child {
    margin-bottom: 0;
}

.issue-item:hover {
    border-color: var(--color-info);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.issue-item-icon {
    font-size: 1.5rem;
    line-height: 1;
    flex-shrink: 0;
}

.issue-item-content {
    flex: 1;
    min-width: 0;
}

.issue-item-name {
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.25rem;
    word-wrap: break-word;
}

.issue-item-description {
    color: var(--color-muted);
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 0.5rem;
}

.issue-item-action {
    flex-shrink: 0;
}

.jump-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    background: var(--color-bg-alt);
    color: var(--color-text);
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.8125rem;
    font-weight: 500;
    transition: all 0.15s ease;
    white-space: nowrap;
}

.jump-link:hover {
    background: var(--color-info);
    color: white;
    transform: translateX(2px);
}

.jump-link::after {
    content: "→";
    font-size: 1rem;
}

@media (max-width: 768px) {
    .issue-item {
        flex-direction: column;
        gap: 0.75rem;
    }

    .issue-item-action {
        align-self: flex-start;
    }

    .issue-summary-header h2 {
        font-size: 1.25rem;
    }
}

/* ===== Comprehensive Device Overview Dashboard ===== */
.device-overview-dashboard {
    margin: 2rem 0;
    padding: 0;
}

.dashboard-section {
    background: var(--color-bg);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-left: 4px solid var(--color-info);
}

.dashboard-section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 1.25rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-icon {
    font-size: 1.75rem;
}

.dashboard-subsection-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 1rem 0;
}

/* Device Identity Grid */
.identity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.identity-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.identity-item label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.identity-item span {
    font-size: 0.9375rem;
    color: var(--color-text);
    font-weight: 500;
}

.identity-item small {
    font-size: 0.8125rem;
    color: var(--color-muted);
}

.value-truncate {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Health Status Grid */
.health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
}

.health-card {
    background: var(--color-bg);
    border-radius: 6px;
    padding: 1rem;
    border: 2px solid var(--color-border);
    text-align: center;
    transition: all 0.2s ease;
}

.health-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
}

.health-card.status-error {
    border-color: var(--color-error);
    background: linear-gradient(135deg, var(--color-bg) 0%, #fef2f2 100%);
}

.health-card.status-warning {
    border-color: var(--color-warning);
    background: linear-gradient(135deg, var(--color-bg) 0%, #fffbeb 100%);
}

.health-card.status-success {
    border-color: var(--color-success);
    background: linear-gradient(135deg, var(--color-bg) 0%, #f0fdf4 100%);
}

.health-card.status-neutral {
    border-color: var(--color-info);
    background: linear-gradient(135deg, var(--color-bg) 0%, #eff6ff 100%);
}

.health-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.health-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.health-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: 0.25rem;
}

.health-source {
    font-size: 0.75rem;
    color: var(--color-muted);
    margin-top: 0.5rem;
}

/* Configuration Summary List */
.config-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.config-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--color-bg);
    border-radius: 6px;
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: all 0.2s ease;
}

.config-row:hover {
    background: #f9fafb;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateX(4px);
}

.config-row.status-error {
    border-left: 4px solid var(--color-error);
}

.config-row.status-warning {
    border-left: 4px solid var(--color-warning);
}

.config-row.status-success {
    border-left: 4px solid var(--color-success);
}

.config-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.config-info {
    flex: 1;
    min-width: 0;
}

.config-title {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.25rem;
}

.config-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.stat-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.125rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.stat-badge.error {
    background: #fef2f2;
    color: var(--color-error);
}

.stat-badge.warning {
    background: #fffbeb;
    color: var(--color-warning);
}

.stat-badge.success {
    background: #f0fdf4;
    color: var(--color-success);
}

.config-total {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text);
    min-width: 40px;
    text-align: right;
}

.config-arrow {
    font-size: 1.5rem;
    color: var(--color-muted);
    flex-shrink: 0;
}

@media (max-width: 768px) {
    .identity-grid {
        grid-template-columns: 1fr;
    }

    .health-grid {
        grid-template-columns: 1fr;
    }

    .config-row {
        padding: 0.75rem;
        gap: 0.75rem;
    }

    .config-icon {
        font-size: 1.25rem;
    }

    .config-total {
        font-size: 1rem;
    }
}

@media print {
    .device-overview-dashboard {
        page-break-inside: avoid;
    }

    .dashboard-section {
        box-shadow: none;
        border: 1px solid var(--color-border);
    }

    .config-row:hover {
        transform: none;
    }
}

/* ============================================================
   VISUAL POLISH — Premium SaaS Dashboard Effects
   ============================================================ */

/* Extended CSS Variables */
:root {
    --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 6px 12px -2px rgba(0,0,0,0.08), 0 3px 6px -3px rgba(0,0,0,0.06);
    --shadow-xl: 0 20px 40px -8px rgba(0,0,0,0.12), 0 8px 16px -8px rgba(0,0,0,0.08);
    --glass-bg: rgba(255,255,255,0.72);
    --glass-border: rgba(255,255,255,0.3);
    --glass-blur: 16px;
    --accent-gp: #2563EB;
    --accent-intune: #7C3AED;
    --accent-sccm: #0D9488;
    --accent-wu: #EA580C;
    --accent-device: #64748B;
    --scrollbar-track: transparent;
    --scrollbar-thumb: rgba(0,0,0,0.15);
    --scrollbar-thumb-hover: rgba(0,0,0,0.28);
}

[data-theme="dark"] {
    --shadow-xs: 0 1px 2px rgba(0,0,0,0.2);
    --shadow-md: 0 6px 12px -2px rgba(0,0,0,0.35), 0 3px 6px -3px rgba(0,0,0,0.3);
    --shadow-xl: 0 20px 40px -8px rgba(0,0,0,0.5), 0 8px 16px -8px rgba(0,0,0,0.35);
    --glass-bg: rgba(15,15,26,0.72);
    --glass-border: rgba(255,255,255,0.08);
    --scrollbar-thumb: rgba(255,255,255,0.15);
    --scrollbar-thumb-hover: rgba(255,255,255,0.28);
}

/* 1. Frosted Glass Nav */
.sticky-nav {
    background: var(--glass-bg) !important;
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(1.4);
    backdrop-filter: blur(var(--glass-blur)) saturate(1.4);
    border-bottom: 1px solid var(--glass-border);
}

/* 2. Card Hover — lift + shadow */
.dashboard-card {
    transition: transform 0.25s cubic-bezier(0.22,1,0.36,1), box-shadow 0.25s cubic-bezier(0.22,1,0.36,1);
    will-change: transform;
    cursor: pointer;
}
.dashboard-card:hover {
    transform: translateY(-3px) scale(1.005);
    box-shadow: var(--shadow-lg);
}
.dashboard-card:active {
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

/* 3. Table Row Hover — left accent slide-in */
table tbody tr {
    position: relative;
}
table tbody tr::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--color-info);
    border-radius: 0 2px 2px 0;
    transform: scaleY(0);
    transform-origin: center;
    transition: transform 0.2s cubic-bezier(0.22,1,0.36,1);
    z-index: 1;
}
table tbody tr:hover::before { transform: scaleY(1); }
[data-domain="gp"] table tbody tr::before { background: var(--accent-gp); }
[data-domain="intune"] table tbody tr::before { background: var(--accent-intune); }
[data-domain="sccm"] table tbody tr::before { background: var(--accent-sccm); }
[data-domain="wu"] table tbody tr::before { background: var(--accent-wu); }
[data-domain="device"] table tbody tr::before { background: var(--accent-device); }

/* Domain-specific hover background */
[data-domain="gp"] table tbody tr:hover { background-color: rgba(37,99,235,0.04); }
[data-domain="intune"] table tbody tr:hover { background-color: rgba(124,58,237,0.04); }
[data-domain="sccm"] table tbody tr:hover { background-color: rgba(13,148,136,0.04); }
[data-domain="wu"] table tbody tr:hover { background-color: rgba(234,88,12,0.04); }
[data-domain="device"] table tbody tr:hover { background-color: rgba(100,116,139,0.04); }
[data-theme="dark"] [data-domain="gp"] table tbody tr:hover { background-color: rgba(37,99,235,0.1); }
[data-theme="dark"] [data-domain="intune"] table tbody tr:hover { background-color: rgba(124,58,237,0.1); }
[data-theme="dark"] [data-domain="sccm"] table tbody tr:hover { background-color: rgba(13,148,136,0.1); }
[data-theme="dark"] [data-domain="wu"] table tbody tr:hover { background-color: rgba(234,88,12,0.1); }
[data-theme="dark"] [data-domain="device"] table tbody tr:hover { background-color: rgba(100,116,139,0.1); }

/* 4. Badge Animations */
@keyframes badge-pulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(220,53,69,0.35); }
    50% { box-shadow: 0 0 0 5px rgba(220,53,69,0); }
}
@keyframes badge-glow {
    0%, 100% { box-shadow: 0 0 4px rgba(40,167,69,0.15); }
    50% { box-shadow: 0 0 10px rgba(40,167,69,0.25); }
}
.badge-danger { animation: badge-pulse 2.2s ease-in-out infinite; }
.badge-success { animation: badge-glow 3s ease-in-out infinite; }

/* 5. Section Entrance Animation */
@keyframes section-enter {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
}
.tab-panel.active .section {
    animation: section-enter 0.35s cubic-bezier(0.22,1,0.36,1) both;
}
.tab-panel.active .section:nth-child(2) { animation-delay: 0.05s; }
.tab-panel.active .section:nth-child(3) { animation-delay: 0.10s; }
.tab-panel.active .section:nth-child(4) { animation-delay: 0.15s; }
.tab-panel.active .section:nth-child(5) { animation-delay: 0.20s; }
.tab-panel.active .section:nth-child(n+6) { animation-delay: 0.25s; }

/* 6. Progress Bar Component */
.progress-bar {
    display: flex;
    width: 100%;
    height: 8px;
    border-radius: 999px;
    overflow: hidden;
    background: var(--color-border);
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
}
.progress-bar-sm { height: 5px; }
.progress-bar-segment {
    height: 100%;
    transition: width 0.6s cubic-bezier(0.22,1,0.36,1);
    min-width: 0;
}
.progress-bar-segment:first-child { border-radius: 999px 0 0 999px; }
.progress-bar-segment:last-child { border-radius: 0 999px 999px 0; }
.progress-bar-segment:only-child { border-radius: 999px; }
.progress-bar-segment.success { background: var(--color-success); }
.progress-bar-segment.warning { background: var(--color-warning); }
.progress-bar-segment.danger { background: var(--color-danger); }
.progress-bar-segment.neutral { background: var(--color-muted); }

/* 7. Summary Strip Component */
.summary-strip {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 10px 16px;
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    margin-bottom: 12px;
    flex-wrap: wrap;
    box-shadow: var(--shadow-xs);
}
.summary-strip-total {
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--color-text);
    white-space: nowrap;
    padding-right: 12px;
    border-right: 1px solid var(--color-border);
}
.summary-strip-total .count { font-size: 1.15rem; }
.summary-strip-stats {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}
.summary-strip-stat {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--color-text-muted);
    white-space: nowrap;
}
.summary-strip-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}
.summary-strip-dot.success { background: var(--color-success); }
.summary-strip-dot.warning { background: var(--color-warning); }
.summary-strip-dot.danger { background: var(--color-danger); }
.summary-strip-dot.neutral { background: var(--color-muted); }
.summary-strip-progress {
    flex: 1;
    min-width: 80px;
    max-width: 220px;
}
[data-theme="dark"] .summary-strip {
    background: rgba(255,255,255,0.03);
    border-color: rgba(255,255,255,0.08);
}

/* 8. Custom Scrollbars */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--scrollbar-track); }
::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 999px;
    border: 2px solid transparent;
    background-clip: padding-box;
}
::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); border: 2px solid transparent; background-clip: padding-box; }
* { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track); }

/* ============================================================
   TAB NAVIGATION SYSTEM
   ============================================================ */
.tab-bar {
    display: flex;
    gap: 2px;
    padding: 8px 0 0 0;
    border-top: 1px solid var(--color-border);
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
}
.tab-bar::-webkit-scrollbar { display: none; }

.tab-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-bottom: 3px solid transparent;
    background: transparent;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: color var(--transition), border-color var(--transition), background var(--transition);
    position: relative;
    border-radius: var(--radius) var(--radius) 0 0;
}
.tab-btn:hover {
    color: var(--color-text);
    background: var(--color-bg-alt);
}
.tab-btn.active {
    color: var(--color-info);
    border-bottom-color: var(--color-info);
    font-weight: 600;
}
.tab-btn-icon { font-size: 1rem; }
.tab-badge {
    background: rgba(0,123,255,0.15);
    color: var(--color-info);
    padding: 1px 7px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 700;
    min-width: 20px;
    text-align: center;
}
.tab-btn.active .tab-badge {
    background: var(--color-info);
    color: white;
}
.tab-badge.has-errors { background: rgba(220,53,69,0.15); color: var(--color-danger); }
.tab-btn.active .tab-badge.has-errors { background: var(--color-danger); color: white; }
.tab-badge.has-warnings { background: rgba(255,193,7,0.15); color: #856404; }
.tab-status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    position: absolute;
    top: 8px;
    right: 8px;
}
.tab-status-dot.error { background: var(--color-danger); }
.tab-status-dot.warning { background: var(--color-warning); }

/* Tab Panels */
.tab-panels { position: relative; }
.tab-panel {
    display: none;
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.25s ease, transform 0.25s ease;
}
.tab-panel.active {
    display: block;
}
.tab-panel.visible {
    opacity: 1;
    transform: translateY(0);
}

/* Per-tab toolbar */
.tab-panel-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    padding: 15px;
    background: var(--color-bg-alt);
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
}

/* Mobile tab dropdown */
.tab-mobile-select {
    display: none;
    width: 100%;
    padding: 10px 15px;
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    font-size: 0.9rem;
    background: var(--color-bg);
    color: var(--color-text);
    margin-top: 8px;
}

@media (max-width: 768px) {
    .tab-bar { display: none; }
    .tab-mobile-select { display: block; }
}

/* Tab system print styles */
@media print {
    .tab-bar, .tab-mobile-select, .tab-panel-toolbar { display: none !important; }
    .tab-panel {
        display: block !important;
        opacity: 1 !important;
        transform: none !important;
    }
    .tab-panel::before {
        content: attr(data-tab-title);
        display: block;
        font-size: 16pt;
        font-weight: bold;
        margin: 20pt 0 10pt;
        padding-bottom: 5pt;
        border-bottom: 2pt solid #000;
    }
}
    </style>
</head>
<body>
    <div id="loading-screen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 10000;">
        <div style="text-align: center; max-width: 600px; padding: 40px;">
            <div style="font-size: 3rem; margin-bottom: 20px;">🧬</div>
            <h2 style="margin: 0 0 10px 0; color: #333;">DeviceDNA Report Viewer</h2>
            <p style="color: #666; margin-bottom: 30px;">Select a DeviceDNA JSON file to view the report.</p>
            <div style="margin: 30px 0;">
                <input type="file" id="json-file-input" accept=".json" style="display: none;">
                <button onclick="document.getElementById('json-file-input').click()"
                        style="background: #007bff; color: white; border: none; padding: 15px 30px;
                               font-size: 16px; border-radius: 6px; cursor: pointer;
                               box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                    📁 Load JSON File
                </button>
            </div>
            <div style="margin-top: 40px; padding-top: 30px; border-top: 1px solid #ddd;">
                <h3 style="color: #555; margin-bottom: 15px; font-size: 14px;">Or use URL parameter:</h3>
                <p style="text-align: left; color: #666; font-size: 13px;">
                    <code>DeviceDNA-HTMLViewer.html?data=PC001/DeviceDNA_PC001.json</code>
                </p>
            </div>
            <p id="loading-status" style="color: #666; margin-top: 20px; font-size: 14px;"></p>
        </div>
    </div>
    <nav class="sticky-nav">
        <div class="nav-container">
            <div class="nav-top">
                <a href="#" class="nav-brand" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">
                    <span class="nav-brand-icon">&#129516;</span>
                    <span>DeviceDNA</span>
                </a>

                <div class="nav-search">
                    <label for="nav-search" class="sr-only">Global search</label>
                    <input type="text" id="nav-search" placeholder="Search policies, apps, groups..." aria-label="Global search">
                </div>

                <div class="nav-filters">
                    <button id="filter-all" class="filter-btn active">All</button>
                    <button id="filter-issues" class="filter-btn filter-issues">Issues</button>
                    <button id="filter-warnings" class="filter-btn filter-warnings">Warnings</button>
                </div>

                <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle navigation menu">&#9776;</button>
            </div>

            <div class="tab-bar" role="tablist" aria-label="Report sections">
                <button class="tab-btn active" data-tab="overview" role="tab" aria-selected="true" tabindex="0">
                    <span class="tab-icon">&#128202;</span>
                    <span class="tab-label">Overview</span>
                    <span class="tab-badge" style="display:none"></span>
                    <span class="tab-status-dot"></span>
                </button>
                <button class="tab-btn" data-tab="gp" role="tab" aria-selected="false" tabindex="-1">
                    <span class="tab-icon">&#128187;</span>
                    <span class="tab-label">Group Policy</span>
                    <span class="tab-badge" style="display:none"></span>
                    <span class="tab-status-dot"></span>
                </button>
                <button class="tab-btn" data-tab="intune" role="tab" aria-selected="false" tabindex="-1">
                    <span class="tab-icon">&#9881;&#65039;</span>
                    <span class="tab-label">Intune</span>
                    <span class="tab-badge" style="display:none"></span>
                    <span class="tab-status-dot"></span>
                </button>
                <button class="tab-btn" data-tab="sccm" role="tab" aria-selected="false" tabindex="-1">
                    <span class="tab-icon">&#9881;</span>
                    <span class="tab-label">SCCM</span>
                    <span class="tab-badge" style="display:none"></span>
                    <span class="tab-status-dot"></span>
                </button>
                <button class="tab-btn" data-tab="wu" role="tab" aria-selected="false" tabindex="-1">
                    <span class="tab-icon">&#128260;</span>
                    <span class="tab-label">Windows Updates</span>
                    <span class="tab-badge" style="display:none"></span>
                    <span class="tab-status-dot"></span>
                </button>
                <button class="tab-btn" data-tab="device" role="tab" aria-selected="false" tabindex="-1">
                    <span class="tab-icon">&#128225;</span>
                    <span class="tab-label">Device</span>
                    <span class="tab-badge" style="display:none"></span>
                    <span class="tab-status-dot"></span>
                </button>
            </div>

            <!-- Mobile tab selector -->
            <select id="tab-mobile-select" class="tab-mobile-select" aria-label="Select report section">
                <option value="overview">Overview</option>
                <option value="gp">Group Policy</option>
                <option value="intune">Intune</option>
                <option value="sccm">SCCM</option>
                <option value="wu">Windows Updates</option>
                <option value="device">Device</option>
            </select>
        </div>
    </nav>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-title-container">
                <h1>🧬 Device DNA Report</h1>
            </div>
            <div id="header-info" class="header-info">
                <!-- Populated by JavaScript -->
            </div>
        </header>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="search-box">
                <label for="global-search" class="sr-only">Search all sections</label>
                <input type="text" id="global-search" placeholder="Search all sections..." aria-label="Search all sections">
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="expandAll()">Expand All</button>
                <button class="btn btn-secondary" onclick="collapseAll()">Collapse All</button>
            </div>
            <div class="export-dropdown">
                <button class="btn btn-primary">Export &#9662;</button>
                <div class="export-dropdown-content">
                    <button onclick="exportMarkdown()">Markdown (.md)</button>
                    <button onclick="exportCSV()">CSV (.csv)</button>
                    <button onclick="exportJSON()">JSON (.json)</button>
                    <button onclick="exportXLSX()">Excel (.xlsx)</button>
                </div>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode">&#127769;</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div class="tab-panel active visible" data-tab="overview" role="tabpanel">
            <!-- Executive Dashboard (populated by JavaScript) -->
            <div id="executive-dashboard-container"></div>

            <!-- Issue Summary (populated by JavaScript) -->
            <div id="issue-summary-container"></div>

            <!-- Collection Issues -->
            <div id="collection-issues-section" class="section collapsed" data-domain="issues">
                <div class="section-header">
                    <h2>
                        <span>&#9888;&#65039;</span>
                        Collection Issues
                        <span class="section-count" id="collection-issues-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content">
                    <div id="collection-issues">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- GROUP POLICY TAB -->
        <div class="tab-panel" data-tab="gp" role="tabpanel" hidden>
            <div id="gp-objects-section" class="section collapsed" data-domain="gp">
                <div class="section-header">
                    <h2>
                        <span>&#128196;</span>
                        Group Policy Objects
                        <span class="section-count" id="gp-objects-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="gp-objects-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="gp-settings-section" class="section collapsed" data-domain="gp">
                <div class="section-header">
                    <h2>
                        <span>&#9881;</span>
                        Group Policy Settings
                        <span class="section-count" id="gp-settings-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="gp-settings-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- INTUNE TAB -->
        <div class="tab-panel" data-tab="intune" role="tabpanel" hidden>
            <div id="intune-groups-device-section" class="section collapsed" data-domain="intune">
                <div class="section-header">
                    <h2>
                        <span>&#128101;</span>
                        Entra ID - Device Groups
                        <span class="section-count" id="device-groups-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="device-groups-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="config-profiles-section" class="section collapsed" data-domain="intune">
                <div class="section-header">
                    <h2>
                        <span>&#128195;</span>
                        Configuration Profiles
                        <span class="section-count" id="config-profiles-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="config-profiles-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="compliance-policies-section" class="section collapsed" data-domain="intune">
                <div class="section-header">
                    <h2>
                        <span>&#9989;</span>
                        Compliance Policies
                        <span class="section-count" id="compliance-policies-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="compliance-policies-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="applications-section" class="section collapsed" data-domain="intune">
                <div class="section-header">
                    <h2>
                        <span>&#128230;</span>
                        Applications
                        <span class="section-count" id="applications-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="applications-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="remediations-section" class="section collapsed" data-domain="intune">
                <div class="section-header">
                    <h2>
                        <span>&#129657;</span>
                        Proactive Remediations
                        <span class="section-count" id="remediations-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="remediations-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- SCCM TAB -->
        <div class="tab-panel" data-tab="sccm" role="tabpanel" hidden>
            <div id="sccm-apps-section" class="section collapsed" data-domain="sccm">
                <div class="section-header">
                    <h2>
                        <span>&#128230;</span>
                        SCCM Applications
                        <span class="section-count" id="sccm-apps-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="sccm-apps-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="sccm-baselines-section" class="section collapsed" data-domain="sccm">
                <div class="section-header">
                    <h2>
                        <span>&#128737;</span>
                        Compliance Baselines
                        <span class="section-count" id="sccm-baselines-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="sccm-baselines-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="sccm-updates-section" class="section collapsed" data-domain="sccm">
                <div class="section-header">
                    <h2>
                        <span>&#128260;</span>
                        Software Updates
                        <span class="section-count" id="sccm-updates-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="sccm-updates-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="sccm-settings-section" class="section collapsed" data-domain="sccm">
                <div class="section-header">
                    <h2>
                        <span>&#9881;</span>
                        Client Settings
                        <span class="section-count" id="sccm-settings-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="sccm-settings-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- WINDOWS UPDATE TAB -->
        <div class="tab-panel" data-tab="wu" role="tabpanel" hidden>
            <div id="wu-summary-section" class="section collapsed" data-domain="wu">
                <div class="section-header">
                    <h2>
                        <span>&#128200;</span>
                        Windows Update Summary
                        <span class="section-count" id="wu-summary-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="wu-summary-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="wu-policy-section" class="section collapsed" data-domain="wu">
                <div class="section-header">
                    <h2>
                        <span>&#128195;</span>
                        Update Policy Settings
                        <span class="section-count" id="wu-policy-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="wu-policy-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="wu-pending-section" class="section collapsed" data-domain="wu">
                <div class="section-header">
                    <h2>
                        <span>&#128260;</span>
                        Pending Updates
                        <span class="section-count" id="wu-pending-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="wu-pending-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div id="wu-history-section" class="section collapsed" data-domain="wu">
                <div class="section-header">
                    <h2>
                        <span>&#128221;</span>
                        Update History
                        <span class="section-count" id="wu-history-count">0</span>
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="wu-history-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- DEVICE TAB -->
        <div class="tab-panel" data-tab="device" role="tabpanel" hidden>
            <div id="device-info-section" class="section collapsed" data-domain="device">
                <div class="section-header">
                    <h2>
                        <span>&#128187;</span>
                        Device Information
                    </h2>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="section-content" id="device-info-content">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Generated by DeviceDNA v0.2.0 | <span id="generation-time"></span></p>
        </footer>
    </div>

    <script type="application/json" id="policy-data">{"deviceInfo":{},"intune":{},"groupPolicy":{},"sccm":{},"windowsUpdate":{},"collectionIssues":[]}</script>
    <script>
// DeviceDNA Report JavaScript

// Global state
let deviceData = null;  // Added for file picker functionality
let policyData = null;
let sheetJSLoaded = false;

// Initialize when DOM is ready
// Note: This DOMContentLoaded listener is disabled for file picker mode
// Initialization is handled by the file picker DOMContentLoaded listener below
// which runs after JSON is loaded via file picker or URL parameter

// document.addEventListener('DOMContentLoaded', function() {
//     // This was for embedded data mode - not used in file picker viewer
// });

function initializeReport() {
    if (!policyData) return;

    // Render all sections (pass policyData to render functions)
    if (typeof renderHeader === 'function') {
        renderHeader(policyData);
    }
    if (typeof renderCollectionIssues === 'function') {
        renderCollectionIssues(policyData);
    }
    if (typeof renderOverviewTab === 'function') {
        renderOverviewTab(policyData);
    }
    if (typeof renderDeviceTab === 'function') {
        renderDeviceTab(policyData);
    }
    if (typeof renderAllOtherSections === 'function') {
        renderAllOtherSections(policyData);
    }
    if (typeof renderAllIntuneSections === 'function') {
        renderAllIntuneSections(policyData.intune);
    }
}

// Collapsible sections
function initializeCollapsibles() {
    document.querySelectorAll('.section-header').forEach(header => {
        header.addEventListener('click', () => {
            const section = header.parentElement;
            section.classList.toggle('collapsed');
        });
    });
}

function expandAll() {
    // Scope to active tab panel if tabs are present
    const activePanel = document.querySelector('.tab-panel.active');
    const scope = activePanel || document;
    scope.querySelectorAll('.section').forEach(section => {
        section.classList.remove('collapsed');
    });
}

function collapseAll() {
    const activePanel = document.querySelector('.tab-panel.active');
    const scope = activePanel || document;
    scope.querySelectorAll('.section').forEach(section => {
        section.classList.add('collapsed');
    });
}

// Table functionality
function initializeTables() {
    // Sortable columns
    document.querySelectorAll('table thead th[data-sort]').forEach(th => {
        th.addEventListener('click', () => sortTable(th));
    });

    // Expandable rows
    document.querySelectorAll('.expandable-row').forEach(row => {
        row.addEventListener('click', (e) => {
            if (e.target.closest('.copy-btn')) return;
            toggleDetailRow(row);
        });
    });

    // Per-table search
    document.querySelectorAll('.table-search input').forEach(input => {
        input.addEventListener('input', (e) => {
            filterTable(e.target);
        });
    });
}

function sortTable(th) {
    // Handle status category sorting specially
    if (th.dataset.sort === 'statusCategory') {
        sortTableByStatus(th);
        return;
    }

    const table = th.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll(':scope > tr:not(.detail-row)'));
    const colIndex = Array.from(th.parentElement.children).indexOf(th);
    const isAsc = th.classList.contains('sorted-asc');

    // Remove sort classes from all headers
    th.parentElement.querySelectorAll('th').forEach(h => {
        h.classList.remove('sorted-asc', 'sorted-desc');
    });

    // Sort rows
    rows.sort((a, b) => {
        const aVal = a.children[colIndex]?.textContent.trim() || '';
        const bVal = b.children[colIndex]?.textContent.trim() || '';

        // Try numeric sort first
        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAsc ? bNum - aNum : aNum - bNum;
        }

        // String sort
        return isAsc ? bVal.localeCompare(aVal) : aVal.localeCompare(bVal);
    });

    // Update class
    th.classList.add(isAsc ? 'sorted-desc' : 'sorted-asc');

    // Reorder rows (keeping detail rows with their parent)
    rows.forEach(row => {
        tbody.appendChild(row);
        const detailRow = document.getElementById('detail-' + row.dataset.id);
        if (detailRow) {
            tbody.appendChild(detailRow);
        }
    });
}

function toggleDetailRow(row) {
    const detailRow = document.getElementById('detail-' + row.dataset.id);
    if (detailRow) {
        const isExpanded = row.classList.toggle('expanded');
        detailRow.classList.toggle('visible');
        // Update ARIA attribute for accessibility
        row.setAttribute('aria-expanded', isExpanded);
    }
}

function filterTable(input) {
    const searchText = input.value.toLowerCase();
    const table = input.closest('.table-container').querySelector('table');
    const rows = table.querySelectorAll('tbody > tr:not(.detail-row)');

    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const visible = text.includes(searchText);
        row.style.display = visible ? '' : 'none';

        // Also hide associated detail row
        const detailRow = document.getElementById('detail-' + row.dataset.id);
        if (detailRow) {
            detailRow.style.display = visible ? '' : 'none';
            if (!visible) {
                row.classList.remove('expanded');
                detailRow.classList.remove('visible');
            }
        }
    });
}

// Global search with debounce
function initializeSearch() {
    const globalSearch = document.getElementById('global-search');
    if (globalSearch) {
        let debounceTimer;
        globalSearch.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const searchText = e.target.value.toLowerCase();

                document.querySelectorAll('.section').forEach(section => {
                    if (!searchText) {
                        section.style.display = '';
                        section.querySelectorAll('tbody > tr').forEach(row => {
                            row.style.display = '';
                        });
                        return;
                    }

                    let hasMatch = false;
                    section.querySelectorAll('tbody > tr:not(.detail-row)').forEach(row => {
                        const text = row.textContent.toLowerCase();
                        const visible = text.includes(searchText);
                        row.style.display = visible ? '' : 'none';
                        if (visible) hasMatch = true;

                        const detailRow = document.getElementById('detail-' + row.dataset.id);
                        if (detailRow) {
                            detailRow.style.display = visible ? '' : 'none';
                        }
                    });

                    // Check section header too
                    const headerText = section.querySelector('.section-header')?.textContent.toLowerCase() || '';
                    if (headerText.includes(searchText)) hasMatch = true;

                    section.style.display = hasMatch ? '' : 'none';
                });
            }, 250); // 250ms debounce delay
        });
    }
}

// Sticky Navigation
function initializeStickyNav() {
    // Mobile menu toggle
    const mobileToggle = document.getElementById('mobile-menu-toggle');
    const navLinks = document.querySelector('.nav-links');
    if (mobileToggle && navLinks) {
        mobileToggle.addEventListener('click', () => {
            navLinks.classList.toggle('mobile-open');
            const isOpen = navLinks.classList.contains('mobile-open');
            mobileToggle.textContent = isOpen ? '\u2715' : '\u2630';
        });
    }

    // Navigation links - smooth scroll
    document.querySelectorAll('.nav-link[data-section]').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = link.dataset.section;
            scrollToSection(sectionId);

            // Close mobile menu
            if (navLinks) {
                navLinks.classList.remove('mobile-open');
                if (mobileToggle) mobileToggle.textContent = '\u2630';
            }
        });
    });

    // Submenu items
    document.querySelectorAll('.nav-submenu-item[data-section]').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const sectionId = item.dataset.section;
            scrollToSection(sectionId);
        });
    });

    // Mobile submenu toggle
    if (window.innerWidth <= 768) {
        document.querySelectorAll('.nav-link.has-submenu').forEach(link => {
            link.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    e.preventDefault();
                    link.classList.toggle('submenu-open');
                }
            });
        });
    }

    // Nav search (use existing global search logic)
    const navSearch = document.getElementById('nav-search');
    const globalSearch = document.getElementById('global-search');
    if (navSearch && globalSearch) {
        navSearch.addEventListener('input', (e) => {
            globalSearch.value = e.target.value;
            globalSearch.dispatchEvent(new Event('input'));
        });
    }

    // Quick filters
    const filterAll = document.getElementById('filter-all');
    const filterIssues = document.getElementById('filter-issues');
    const filterWarnings = document.getElementById('filter-warnings');

    if (filterAll) {
        filterAll.addEventListener('click', () => {
            clearFilters();
            filterAll.classList.add('active');
            filterIssues.classList.remove('active');
            filterWarnings.classList.remove('active');
        });
    }

    if (filterIssues) {
        filterIssues.addEventListener('click', () => {
            applyFilter('issues');
            filterAll.classList.remove('active');
            filterIssues.classList.add('active');
            filterWarnings.classList.remove('active');
        });
    }

    if (filterWarnings) {
        filterWarnings.addEventListener('click', () => {
            applyFilter('warnings');
            filterAll.classList.remove('active');
            filterIssues.classList.remove('active');
            filterWarnings.classList.add('active');
        });
    }

    // Update nav counts
    updateNavCounts();

    // Highlight active section on scroll
    let scrollTimeout;
    window.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(updateActiveNavLink, 100);
    });
}

function scrollToSection(sectionId) {
    const section = document.getElementById(sectionId);
    if (section) {
        // Switch to the correct tab if section is inside a tab panel
        const tabPanel = section.closest('.tab-panel');
        if (tabPanel && tabPanel.dataset.tab) {
            switchTab(tabPanel.dataset.tab);
        }

        // Expand section if collapsed
        section.classList.remove('collapsed');

        // Calculate offset for sticky nav
        const navHeight = document.querySelector('.sticky-nav') ? document.querySelector('.sticky-nav').offsetHeight : 0;
        const offset = section.offsetTop - navHeight - 10;

        setTimeout(() => {
            window.scrollTo({
                top: offset,
                behavior: 'smooth'
            });
        }, 50);
    }
}

function updateActiveNavLink() {
    const navHeight = document.querySelector('.sticky-nav')?.offsetHeight || 0;
    const scrollPos = window.scrollY + navHeight + 50;

    const sections = document.querySelectorAll('.section[id]');
    let activeSection = null;

    sections.forEach(section => {
        if (section.offsetTop <= scrollPos) {
            activeSection = section.id;
        }
    });

    // Update active nav link
    document.querySelectorAll('.nav-link[data-section]').forEach(link => {
        if (link.dataset.section === activeSection) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
}

function updateNavCounts() {
    if (!policyData) return;

    // Update counts in navigation
    const sections = {
        'device-info-section': 1,
        'gp-computer-section': policyData.groupPolicy?.computerScope?.appliedGPOs?.length || 0,
        'intune-groups-device-section': policyData.intune?.deviceGroups?.length || 0,
        'intune-profiles-section': policyData.intune?.configurationProfiles?.length || 0,
        'intune-apps-section': policyData.intune?.applications?.length || 0,
        'intune-compliance-section': policyData.intune?.compliancePolicies?.length || 0,
        'intune-scripts-section': policyData.intune?.proactiveRemediations?.length || 0
    };

    Object.keys(sections).forEach(sectionId => {
        const countElement = document.querySelector(`[data-section="${sectionId}"] .nav-link-count`);
        if (countElement) {
            const count = sections[sectionId];
            if (count > 0) {
                countElement.textContent = count;
            } else {
                countElement.style.display = 'none';
            }
        }
    });

    // Add error/warning indicators
    updateNavStatusIndicators();
}

function updateNavStatusIndicators() {
    if (!policyData) return;

    // Count issues and warnings in each section
    const indicators = {};

    // Collection issues (filtered by management type)
    if (policyData.collectionIssues?.length > 0) {
        const mgmtType = (policyData.deviceInfo?.managementType || '').toLowerCase();
        const relevantIssues = policyData.collectionIssues.filter(issue => {
            const phase = (issue.phase || '').toLowerCase();
            if (mgmtType === 'cloud-only' || mgmtType === 'azure ad joined') {
                if (phase === 'group policy' && issue.severity !== 'Error') return false;
            }
            if (mgmtType.startsWith('on-prem')) {
                if ((phase === 'intune' || phase === 'local intune') && issue.severity !== 'Error') return false;
            }
            return true;
        });
        const errors = relevantIssues.filter(i => i.severity === 'Error').length;
        const warnings = relevantIssues.filter(i => i.severity === 'Warning').length;
        if (errors > 0 || warnings > 0) {
            indicators['collection-issues-section'] = { errors, warnings };
        }
    }

    // Intune apps
    if (policyData.intune?.applications?.length > 0) {
        let errors = 0;
        let warnings = 0;
        policyData.intune.applications.forEach(app => {
            const status = (app.installState || '').toLowerCase();
            if (status.includes('failed') || status.includes('error')) errors++;
            else if (status.includes('pending') || status.includes('available')) warnings++;
        });
        if (errors > 0 || warnings > 0) {
            indicators['intune-apps-section'] = { errors, warnings };
        }
    }

    // Intune compliance
    if (policyData.intune?.compliancePolicies?.length > 0) {
        let errors = 0;
        let warnings = 0;
        policyData.intune.compliancePolicies.forEach(policy => {
            const status = (policy.complianceState || '').toLowerCase();
            if (status.includes('noncompliant') || status.includes('error')) errors++;
            else if (status.includes('conflict')) warnings++;
        });
        if (errors > 0 || warnings > 0) {
            indicators['intune-compliance-section'] = { errors, warnings };
        }
    }

    // Add indicators to nav links
    Object.keys(indicators).forEach(sectionId => {
        const link = document.querySelector(`[data-section="${sectionId}"]`);
        if (link) {
            let statusHtml = '<span class="nav-link-status">';
            if (indicators[sectionId].errors > 0) {
                statusHtml += `<span title="${indicators[sectionId].errors} errors" style="color:var(--color-danger)">\u{1F534} ${indicators[sectionId].errors}</span>`;
            }
            if (indicators[sectionId].warnings > 0) {
                statusHtml += ` <span title="${indicators[sectionId].warnings} warnings" style="color:var(--color-warning)">\u{1F7E1} ${indicators[sectionId].warnings}</span>`;
            }
            statusHtml += '</span>';

            const existing = link.querySelector('.nav-link-status');
            if (existing) {
                existing.remove();
            }
            link.insertAdjacentHTML('beforeend', statusHtml);
        }
    });
}

function applyFilter(filterType) {
    // Clear search
    const globalSearch = document.getElementById('global-search');
    const navSearch = document.getElementById('nav-search');
    if (globalSearch) globalSearch.value = '';
    if (navSearch) navSearch.value = '';

    document.querySelectorAll('.section').forEach(section => {
        section.style.display = '';

        let hasVisibleRows = false;
        section.querySelectorAll('tbody > tr:not(.detail-row)').forEach(row => {
            const badges = row.querySelectorAll('.badge');
            let visible = false;

            if (filterType === 'issues') {
                // Show rows with error/danger badges
                badges.forEach(badge => {
                    if (badge.classList.contains('badge-danger') ||
                        badge.textContent.toLowerCase().includes('failed') ||
                        badge.textContent.toLowerCase().includes('error') ||
                        badge.textContent.toLowerCase().includes('noncompliant')) {
                        visible = true;
                    }
                });
            } else if (filterType === 'warnings') {
                // Show rows with warning badges
                badges.forEach(badge => {
                    if (badge.classList.contains('badge-warning') ||
                        badge.textContent.toLowerCase().includes('pending') ||
                        badge.textContent.toLowerCase().includes('conflict')) {
                        visible = true;
                    }
                });
            }

            row.style.display = visible ? '' : 'none';
            if (visible) hasVisibleRows = true;

            // Hide detail row if parent hidden
            const detailRow = document.getElementById('detail-' + row.dataset.id);
            if (detailRow && !visible) {
                detailRow.style.display = 'none';
                row.classList.remove('expanded');
                detailRow.classList.remove('visible');
            }
        });

        // Hide section if no visible rows
        if (!hasVisibleRows && section.querySelector('table')) {
            section.style.display = 'none';
        }
    });
}

function clearFilters() {
    // Clear search
    const globalSearch = document.getElementById('global-search');
    const navSearch = document.getElementById('nav-search');
    if (globalSearch) globalSearch.value = '';
    if (navSearch) navSearch.value = '';

    // Show all sections and rows
    document.querySelectorAll('.section').forEach(section => {
        section.style.display = '';
        section.querySelectorAll('tbody > tr').forEach(row => {
            row.style.display = '';
        });
    });
}

// Theme toggle
function initializeTheme() {
    const savedTheme = localStorage.getItem('devicedna-theme');
    if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon();
    }
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

    if (newTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
    } else {
        document.documentElement.removeAttribute('data-theme');
    }

    localStorage.setItem('devicedna-theme', newTheme);
    updateThemeIcon();
}

function updateThemeIcon() {
    const btn = document.querySelector('.theme-toggle');
    if (btn) {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        btn.textContent = isDark ? '\u2600\uFE0F' : '\uD83C\uDF19';
    }
}

// Copy to clipboard
function copyToClipboard(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('copied');
        const originalText = btn.textContent;
        btn.textContent = '\u2713';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove('copied');
        }, 1500);
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

// Export functionality
function initializeExport() {
    const exportBtn = document.querySelector('.export-dropdown .btn');
    const dropdown = document.querySelector('.export-dropdown');

    if (exportBtn && dropdown) {
        exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('open');
        });

        document.addEventListener('click', () => {
            dropdown.classList.remove('open');
        });
    }
}

// Print functionality

function initializePrintHandlers() {
    window.addEventListener('beforeprint', function() {
        // Expand all collapsed sections
        document.querySelectorAll('.section.collapsed').forEach(section => {
            section.classList.remove('collapsed');
            section.setAttribute('data-was-collapsed', 'true');
        });

        // Show all detail rows
        document.querySelectorAll('.detail-row').forEach(row => {
            if (!row.classList.contains('visible')) {
                row.classList.add('visible');
                row.setAttribute('data-was-hidden', 'true');
            }
        });
    });

    window.addEventListener('afterprint', function() {
        // Optionally restore collapsed state
        // Left empty for now - users may want to keep sections expanded after printing
    });
}

function getDeviceName() {
    return policyData?.deviceInfo?.name || 'Device';
}

function getTimestamp() {
    const date = new Date();
    return date.toISOString().slice(0, 10);
}

// Export to Markdown
function exportMarkdown() {
    if (!policyData) return;

    let md = `# DeviceDNA Report: ${escapeMarkdown(getDeviceName())}\n\n`;
    md += `**Generated:** ${policyData.metadata?.collectionTime || new Date().toISOString()}\n\n`;

    // Device Info
    const device = policyData.deviceInfo || {};
    md += `## Device Information\n\n`;
    md += `| Property | Value |\n|----------|-------|\n`;
    md += `| Name | ${escapeMarkdown(device.name || 'N/A')} |\n`;
    md += `| FQDN | ${escapeMarkdown(device.fqdn || 'N/A')} |\n`;
    md += `| OS | ${escapeMarkdown(device.osName || 'N/A')} ${escapeMarkdown(device.osVersion || '')} |\n`;
    md += `| Serial | ${escapeMarkdown(device.serialNumber || 'N/A')} |\n`;
    md += `| Join Type | ${escapeMarkdown(device.joinType || 'N/A')} |\n`;
    md += `| Management | ${escapeMarkdown(device.managementType || 'N/A')} |\n`;
    md += `| Tenant ID | ${escapeMarkdown(device.tenantId || 'N/A')} |\n\n`;

    // Collection Issues
    if (policyData.collectionIssues?.length > 0) {
        md += `## Collection Issues\n\n`;
        policyData.collectionIssues.forEach(issue => {
            md += `- **${escapeMarkdown(issue.severity)}** (${escapeMarkdown(issue.phase)}): ${escapeMarkdown(issue.message)}\n`;
        });
        md += '\n';
    }

    // Group Policy
    const gp = policyData.groupPolicy || {};
    if (gp.computerScope?.appliedGPOs?.length > 0) {
        md += `## Group Policy - Computer Scope\n\n`;
        md += `| Name | Link | Status |\n|------|------|--------|\n`;
        gp.computerScope.appliedGPOs.forEach(gpo => {
            md += `| ${escapeMarkdown(gpo.name || 'N/A')} | ${escapeMarkdown(gpo.link || 'N/A')} | ${escapeMarkdown(gpo.status || 'Applied')} |\n`;
        });
        md += '\n';
    }

    // Intune
    const intune = policyData.intune || {};

    if (intune.deviceGroups?.length > 0) {
        md += `## Entra ID - Device Groups\n\n`;
        md += `| Group Name | Type |\n|------------|------|\n`;
        intune.deviceGroups.forEach(g => {
            md += `| ${escapeMarkdown(g.displayName || g.name || 'N/A')} | ${escapeMarkdown(g.groupType || 'Security')} |\n`;
        });
        md += '\n';
    }

    if (intune.configurationProfiles?.length > 0) {
        md += `## Intune - Configuration Profiles\n\n`;
        md += `| Name | Type | Platform | Status |\n|------|------|----------|--------|\n`;
        intune.configurationProfiles.forEach(p => {
            md += `| ${escapeMarkdown(p.displayName || p.name || 'N/A')} | ${escapeMarkdown(p.profileType || p.policyType || 'N/A')} | ${escapeMarkdown(p.platform || 'N/A')} | ${escapeMarkdown(p.deploymentState || p.targetingStatus || 'N/A')} |\n`;
        });
        md += '\n';

        // Include settings for profiles that have them
        const profilesWithSettings = intune.configurationProfiles.filter(p => p.settings?.length > 0);
        if (profilesWithSettings.length > 0) {
            md += `### Profile Settings Detail\n\n`;
            profilesWithSettings.forEach(p => {
                md += `**${escapeMarkdown(p.displayName || p.name)}** (${p.settings.length} settings)\n\n`;
                md += `| Setting | Value |\n|---------|-------|\n`;
                p.settings.forEach(s => {
                    const val = String(s.value || '').substring(0, 200);
                    md += `| ${escapeMarkdown(s.name || 'Unknown')} | ${escapeMarkdown(val)} |\n`;
                });
                md += '\n';
            });
        }
    }

    if (intune.applications?.length > 0) {
        md += `## Intune - Applications\n\n`;
        md += `| Name | Type | Publisher | Intent | Installed |\n|------|------|-----------|--------|----------|\n`;
        intune.applications.forEach(a => {
            md += `| ${escapeMarkdown(a.displayName || a.name || 'N/A')} | ${escapeMarkdown(a.appType || 'N/A')} | ${escapeMarkdown(a.publisher || 'N/A')} | ${escapeMarkdown(a.intent || 'N/A')} | ${escapeMarkdown(a.appInstallState || 'Unknown')} |\n`;
        });
        md += '\n';
    }

    if (intune.compliancePolicies?.length > 0) {
        md += `## Intune - Compliance Policies\n\n`;
        md += `| Name | Platform | Status | State |\n|------|----------|--------|-------|\n`;
        intune.compliancePolicies.forEach(c => {
            md += `| ${escapeMarkdown(c.displayName || c.name || 'N/A')} | ${escapeMarkdown(c.platform || 'N/A')} | ${escapeMarkdown(c.targetingStatus || 'N/A')} | ${escapeMarkdown(c.complianceState || 'N/A')} |\n`;
        });
        md += '\n';
    }

    downloadFile(md, `DeviceDNA_${getDeviceName()}_${getTimestamp()}.md`, 'text/markdown');
}

function escapeMarkdown(text) {
    if (!text) return '';
    return String(text).replace(/[|\\`*_{}[\]()#+\-.!]/g, '\\$&');
}

// Export to CSV
function exportCSV() {
    if (!policyData) return;

    const sections = [];

    // Device Info
    const device = policyData.deviceInfo || {};
    sections.push({
        name: 'DeviceInfo',
        data: [{
            Name: device.name,
            FQDN: device.fqdn,
            OS: device.osName,
            OSVersion: device.osVersion,
            Serial: device.serialNumber,
            JoinType: device.joinType,
            Management: device.managementType,
            TenantID: device.tenantId,
            CurrentUser: device.currentUser
        }]
    });

    // Computer GPOs
    const gp = policyData.groupPolicy || {};
    if (gp.computerScope?.appliedGPOs?.length > 0) {
        sections.push({
            name: 'ComputerGPOs',
            data: gp.computerScope.appliedGPOs.map(g => ({
                Name: g.name,
                Link: g.link,
                Status: g.status || 'Applied',
                Order: g.order
            }))
        });
    }

    // Intune data
    const intune = policyData.intune || {};

    if (intune.deviceGroups?.length > 0) {
        sections.push({
            name: 'DeviceGroups',
            data: intune.deviceGroups.map(g => ({
                Name: g.displayName || g.name,
                Type: g.groupType,
                ID: g.id
            }))
        });
    }

    if (intune.configurationProfiles?.length > 0) {
        sections.push({
            name: 'ConfigProfiles',
            data: intune.configurationProfiles.map(p => ({
                Name: p.displayName || p.name,
                Type: p.profileType || p.policyType,
                Platform: p.platform,
                Status: p.deploymentState || p.targetingStatus,
                TargetGroups: (p.targetGroups || []).join('; '),
                SettingsCount: p.settings?.length || 0
            }))
        });

        // Separate sheet/section for profile settings detail
        const settingsRows = [];
        intune.configurationProfiles.forEach(p => {
            if (p.settings?.length > 0) {
                p.settings.forEach(s => {
                    settingsRows.push({
                        ProfileName: p.displayName || p.name,
                        ProfileType: p.profileType || p.policyType,
                        SettingName: s.name || 'Unknown',
                        Value: String(s.value || '').substring(0, 500)
                    });
                });
            }
        });
        if (settingsRows.length > 0) {
            sections.push({
                name: 'ProfileSettings',
                data: settingsRows
            });
        }
    }

    if (intune.applications?.length > 0) {
        sections.push({
            name: 'Applications',
            data: intune.applications.map(a => ({
                Name: a.displayName || a.name,
                Type: a.appType,
                Publisher: a.publisher,
                Intent: a.intent,
                TargetingStatus: a.targetingStatus,
                Installed: a.appInstallState || 'Unknown'
            }))
        });
    }

    if (intune.compliancePolicies?.length > 0) {
        sections.push({
            name: 'CompliancePolicies',
            data: intune.compliancePolicies.map(c => ({
                Name: c.displayName || c.name,
                Platform: c.platform,
                TargetingStatus: c.targetingStatus,
                ComplianceState: c.complianceState
            }))
        });
    }

    // Generate combined CSV with section headers
    let csv = '';
    sections.forEach(section => {
        if (section.data.length === 0) return;

        csv += `\n=== ${section.name} ===\n`;
        const headers = Object.keys(section.data[0]);
        csv += headers.map(h => escapeCSV(h)).join(',') + '\n';
        section.data.forEach(row => {
            csv += headers.map(h => escapeCSV(row[h])).join(',') + '\n';
        });
    });

    downloadFile(csv, `DeviceDNA_${getDeviceName()}_${getTimestamp()}.csv`, 'text/csv');
}

function escapeCSV(value) {
    if (value === null || value === undefined) return '';
    let str = String(value);

    // Prevent CSV formula injection - prefix cells starting with =, +, -, @ with a tab character
    if (str.length > 0 && /^[=+\-@]/.test(str)) {
        str = '\t' + str;
    }

    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
    }
    return str;
}

// Export to JSON
function exportJSON() {
    if (!policyData) return;

    const json = JSON.stringify(policyData, null, 2);
    downloadFile(json, `DeviceDNA_${getDeviceName()}_${getTimestamp()}.json`, 'application/json');
}

// Export to XLSX using SheetJS
async function exportXLSX() {
    if (!policyData) return;

    const btn = document.querySelector('[onclick="exportXLSX()"]');
    if (btn) {
        btn.classList.add('loading');
        btn.disabled = true;
    }

    try {
        // Load SheetJS if not already loaded
        if (!sheetJSLoaded) {
            await loadSheetJS();
        }

        // Create workbook
        const wb = XLSX.utils.book_new();

        // Summary sheet
        const summaryData = [
            ['DeviceDNA Report'],
            [''],
            ['Device Name', policyData.deviceInfo?.name || 'N/A'],
            ['Collection Time', policyData.metadata?.collectionTime || 'N/A'],
            ['Collected By', policyData.metadata?.collectedBy || 'N/A'],
            ['Version', policyData.metadata?.version || 'N/A'],
            [''],
            ['Tenant ID', policyData.deviceInfo?.tenantId || 'N/A'],
            ['OS', (policyData.deviceInfo?.osName || '') + ' ' + (policyData.deviceInfo?.osVersion || '')],
            ['Join Type', policyData.deviceInfo?.joinType || 'N/A'],
            ['Management', policyData.deviceInfo?.managementType || 'N/A']
        ];
        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(wb, summarySheet, 'Summary');

        // Device Info sheet
        const device = policyData.deviceInfo || {};
        const deviceData = [
            ['Property', 'Value'],
            ['Name', device.name],
            ['FQDN', device.fqdn],
            ['OS Name', device.osName],
            ['OS Version', device.osVersion],
            ['Serial Number', device.serialNumber],
            ['Join Type', device.joinType],
            ['Management', device.managementType],
            ['Tenant ID', device.tenantId],
            ['Current User', device.currentUser]
        ];
        const deviceSheet = XLSX.utils.aoa_to_sheet(deviceData);
        XLSX.utils.book_append_sheet(wb, deviceSheet, 'Device Info');

        // Computer GPOs
        const gp = policyData.groupPolicy || {};
        if (gp.computerScope?.appliedGPOs?.length > 0) {
            const gpoData = [['Name', 'Link', 'Status', 'Order']];
            gp.computerScope.appliedGPOs.forEach(g => {
                gpoData.push([g.name, g.link, g.status || 'Applied', g.order]);
            });
            const gpoSheet = XLSX.utils.aoa_to_sheet(gpoData);
            XLSX.utils.book_append_sheet(wb, gpoSheet, 'Computer GPOs');
        }

        // Intune data
        const intune = policyData.intune || {};

        // Entra ID Device Groups
        if (intune.deviceGroups?.length > 0) {
            const groupData = [['Name', 'Type', 'ID']];
            intune.deviceGroups.forEach(g => {
                groupData.push([g.displayName || g.name, g.groupType, g.id]);
            });
            const groupSheet = XLSX.utils.aoa_to_sheet(groupData);
            XLSX.utils.book_append_sheet(wb, groupSheet, 'Entra ID Device Groups');
        }

        // Configuration Profiles
        if (intune.configurationProfiles?.length > 0) {
            const profileData = [['Name', 'Type', 'Platform', 'Assigned Via', 'Status', 'Settings Count', 'Target Groups']];
            intune.configurationProfiles.forEach(p => {
                profileData.push([
                    p.displayName || p.name,
                    p.policyType,
                    p.platform,
                    p.targetingStatus,
                    p.deploymentState || 'Unknown',
                    p.settings?.length || 0,
                    (p.targetGroups || []).join(', ')
                ]);
            });
            const profileSheet = XLSX.utils.aoa_to_sheet(profileData);
            XLSX.utils.book_append_sheet(wb, profileSheet, 'Config Profiles');

            // Profile Settings detail sheet
            const settingsData = [['Profile Name', 'Profile Type', 'Setting Name', 'Value']];
            intune.configurationProfiles.forEach(p => {
                if (p.settings?.length > 0) {
                    p.settings.forEach(s => {
                        settingsData.push([
                            p.displayName || p.name,
                            p.policyType,
                            s.name || 'Unknown',
                            String(s.value || '').substring(0, 500)
                        ]);
                    });
                }
            });
            if (settingsData.length > 1) {
                const settingsSheet = XLSX.utils.aoa_to_sheet(settingsData);
                XLSX.utils.book_append_sheet(wb, settingsSheet, 'Profile Settings');
            }
        }

        // Applications
        if (intune.applications?.length > 0) {
            const appData = [['Name', 'Version', 'Publisher', 'Type', 'Intent', 'Installed', 'Assigned Via']];
            intune.applications.forEach(a => {
                appData.push([
                    a.displayName || a.name,
                    a.appVersion || 'N/A',
                    a.publisher,
                    a.appType,
                    a.intent,
                    a.appInstallState || (a.installedOnDevice ? 'Installed' : 'Not Installed'),
                    a.targetingStatus
                ]);
            });
            const appSheet = XLSX.utils.aoa_to_sheet(appData);
            XLSX.utils.book_append_sheet(wb, appSheet, 'Applications');
        }

        // Compliance Policies
        if (intune.compliancePolicies?.length > 0) {
            const complianceData = [['Name', 'Platform', 'Assigned Via', 'Compliance State']];
            intune.compliancePolicies.forEach(c => {
                complianceData.push([
                    c.displayName || c.name,
                    c.platform,
                    c.targetingStatus,
                    c.complianceState
                ]);
            });
            const complianceSheet = XLSX.utils.aoa_to_sheet(complianceData);
            XLSX.utils.book_append_sheet(wb, complianceSheet, 'Compliance Policies');
        }

        // Collection Issues
        if (policyData.collectionIssues?.length > 0) {
            const issueData = [['Severity', 'Phase', 'Message']];
            policyData.collectionIssues.forEach(i => {
                issueData.push([i.severity, i.phase, i.message]);
            });
            const issueSheet = XLSX.utils.aoa_to_sheet(issueData);
            XLSX.utils.book_append_sheet(wb, issueSheet, 'Collection Issues');
        }

        // Download
        XLSX.writeFile(wb, `DeviceDNA_${getDeviceName()}_${getTimestamp()}.xlsx`);

    } catch (error) {
        console.error('XLSX export failed:', error);
        alert('Failed to export XLSX. Please try again or use another format.');
    } finally {
        if (btn) {
            btn.classList.remove('loading');
            btn.disabled = false;
        }
    }
}

function loadSheetJS() {
    return new Promise((resolve, reject) => {
        if (typeof XLSX !== 'undefined') {
            sheetJSLoaded = true;
            resolve();
            return;
        }

        const script = document.createElement('script');
        script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.mini.min.js';
        script.onload = () => {
            sheetJSLoaded = true;
            resolve();
        };
        script.onerror = () => {
            // Hide XLSX export button and show tooltip when CDN is unreachable
            const xlsxBtn = document.querySelector('.export-dropdown a[onclick*="exportXLSX"]');
            if (xlsxBtn) {
                xlsxBtn.style.display = 'none';
            }
            reject(new Error('Failed to load SheetJS library (CDN unreachable or offline)'));
        };
        document.head.appendChild(script);
    });
}

// Helper function to download file
function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Render functions
function renderHeader() {
    // Header is rendered server-side, but we can update dynamic values here
}

function renderCollectionIssues() {
    const container = document.getElementById('collection-issues');
    if (!container || !policyData.collectionIssues?.length) {
        if (container) container.style.display = 'none';
        return;
    }

    // Filter out irrelevant issues based on management type
    const mgmtType = (policyData.deviceInfo?.managementType || '').toLowerCase();
    const filtered = policyData.collectionIssues.filter(issue => {
        const phase = (issue.phase || '').toLowerCase();
        const msg = (issue.message || '').toLowerCase();
        // Cloud-only: suppress GP-related info/warnings (no AD)
        if (mgmtType === 'cloud-only' || mgmtType === 'azure ad joined') {
            if (phase === 'group policy' && issue.severity !== 'Error') return false;
        }
        // On-prem only: suppress Intune-related info/warnings
        if (mgmtType.startsWith('on-prem')) {
            if ((phase === 'intune' || phase === 'local intune') && issue.severity !== 'Error') return false;
        }
        return true;
    });

    if (!filtered.length) {
        container.style.display = 'none';
        return;
    }

    let html = '';
    filtered.forEach(issue => {
        const iconMap = { Error: '\u274C', Warning: '\u26A0\uFE0F', Info: '\u2139\uFE0F' };
        const classMap = { Error: 'alert-danger', Warning: 'alert-warning', Info: 'alert-info' };

        html += `
            <div class="alert ${classMap[issue.severity] || 'alert-info'}">
                <span class="alert-icon">${iconMap[issue.severity] || '\u2139\uFE0F'}</span>
                <div>
                    <strong>${escapeHtml(issue.phase)}</strong>: ${escapeHtml(issue.message)}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function renderGroupPolicy() {
    // GP sections are rendered server-side for better initial load
}

function renderIntune() {
    // Intune sections are rendered server-side for better initial load
}

// Utility function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get status badge HTML
function getStatusBadge(status) {
    const statusLower = (status || '').toLowerCase();
    let badgeClass = 'badge-muted';

    if (statusLower.includes('applied') || statusLower.includes('compliant') ||
        statusLower.includes('targeted') || statusLower.includes('installed') ||
        statusLower.includes('success')) {
        badgeClass = 'badge-success';
    } else if (statusLower.includes('warning') || statusLower.includes('pending')) {
        badgeClass = 'badge-warning';
    } else if (statusLower.includes('denied') || statusLower.includes('error') ||
               statusLower.includes('non-compliant') || statusLower.includes('failed')) {
        badgeClass = 'badge-danger';
    } else if (statusLower.includes('info')) {
        badgeClass = 'badge-info';
    }

    return `<span class="badge ${badgeClass}">${escapeHtml(status || 'Unknown')}</span>`;
}

// ===== TABLE ENHANCEMENTS =====

function initializeTableEnhancements() {
    updateAllStatusCounts();
    initializeFilterButtons();
    applyDefaultSort();
}

function updateAllStatusCounts() {
    document.querySelectorAll('.section-status-counts').forEach(countsEl => {
        const sectionName = countsEl.dataset.section;
        const tableContainer = document.querySelector(`.table-container[data-section="${sectionName}"]`);
        if (!tableContainer) return;

        const table = tableContainer.querySelector('table tbody');
        if (!table) return;

        const counts = { error: 0, warning: 0, success: 0, neutral: 0 };
        table.querySelectorAll(':scope > tr[data-status-category]:not(.detail-row)').forEach(row => {
            const category = row.dataset.statusCategory;
            if (counts.hasOwnProperty(category)) {
                counts[category]++;
            }
        });

        // Update error count (with null check)
        const errorEl = countsEl.querySelector('.status-count.error');
        if (errorEl) {
            errorEl.dataset.count = counts.error;
            const errorCountEl = errorEl.querySelector('.count');
            if (errorCountEl) errorCountEl.textContent = counts.error;
        }

        // Update warning count (with null check)
        const warningEl = countsEl.querySelector('.status-count.warning');
        if (warningEl) {
            warningEl.dataset.count = counts.warning;
            const warningCountEl = warningEl.querySelector('.count');
            if (warningCountEl) warningCountEl.textContent = counts.warning;
        }

        // Update success count (with null check)
        const successEl = countsEl.querySelector('.status-count.success');
        if (successEl) {
            successEl.dataset.count = counts.success;
            const successCountEl = successEl.querySelector('.count');
            if (successCountEl) successCountEl.textContent = counts.success;
        }
    });
}

function initializeFilterButtons() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = this.closest('.table-container');
            const filter = this.dataset.filter;

            container.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            applyTableFilter(container, filter);
        });
    });
}

function applyTableFilter(container, filter) {
    const table = container.querySelector('table tbody');
    if (!table) return;

    table.querySelectorAll(':scope > tr:not(.detail-row)').forEach(row => {
        const category = row.dataset.statusCategory;
        let visible = (filter === 'all') || (filter === 'issues' && (category === 'error' || category === 'warning'));

        row.style.display = visible ? '' : 'none';

        const detailRow = document.getElementById('detail-' + row.dataset.id);
        if (detailRow) {
            detailRow.style.display = visible ? '' : 'none';
            if (!visible) {
                row.classList.remove('expanded');
                detailRow.classList.remove('visible');
            }
        }
    });
}

function applyDefaultSort() {
    // Sort all tables alphabetically by name column by default
    document.querySelectorAll('table thead th[data-sort="name"]').forEach(th => {
        const table = th.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll(':scope > tr:not(.detail-row)'));

        // Sort alphabetically by name (case-insensitive)
        rows.sort((a, b) => {
            const aCell = a.querySelector('td:nth-child(' + (th.cellIndex + 1) + ')');
            const bCell = b.querySelector('td:nth-child(' + (th.cellIndex + 1) + ')');
            const aText = aCell?.textContent.trim() || '';
            const bText = bCell?.textContent.trim() || '';
            return aText.localeCompare(bText, undefined, { sensitivity: 'base' });
        });

        // Apply sorted-asc class to name header
        th.parentElement.querySelectorAll('th').forEach(h => {
            h.classList.remove('sorted-asc', 'sorted-desc');
        });
        th.classList.add('sorted-asc');

        // Reorder rows in DOM
        rows.forEach(row => {
            tbody.appendChild(row);
            const detailRow = document.getElementById('detail-' + row.dataset.id);
            if (detailRow) {
                tbody.appendChild(detailRow);
            }
        });
    });
}

function sortTableByStatus(th) {
    const table = th.closest('table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll(':scope > tr:not(.detail-row)'));

    const statusOrder = { error: 1, warning: 2, success: 3, neutral: 4 };

    rows.sort((a, b) => {
        const aCategory = a.dataset.statusCategory || 'neutral';
        const bCategory = b.dataset.statusCategory || 'neutral';
        const aOrder = statusOrder[aCategory] || 999;
        const bOrder = statusOrder[bCategory] || 999;

        if (aOrder !== bOrder) {
            return aOrder - bOrder;
        }

        const aName = a.children[1]?.textContent.trim() || '';
        const bName = b.children[1]?.textContent.trim() || '';
        return aName.localeCompare(bName);
    });

    th.parentElement.querySelectorAll('th').forEach(h => {
        h.classList.remove('sorted-asc', 'sorted-desc');
    });
    th.classList.add('sorted-asc');

    rows.forEach(row => {
        tbody.appendChild(row);
        const detailRow = document.getElementById('detail-' + row.dataset.id);
        if (detailRow) {
            tbody.appendChild(detailRow);
        }
    });
}

// ===== ISSUE SUMMARY =====

function buildIssueSummary() {
    const issues = { critical: [], warnings: [] };

    // Scan all tables for issues
    document.querySelectorAll('table tbody > tr[data-status-category]').forEach(row => {
        const category = row.dataset.statusCategory;
        if (category !== 'error' && category !== 'warning') return;

        const cells = row.querySelectorAll('td');
        if (cells.length < 2) return;

        // Extract name (usually second column after status icon)
        const name = cells[1]?.textContent.trim() || 'Unknown';

        // Determine type from section
        const section = row.closest('.section');
        const sectionHeader = section?.querySelector('.section-header h2')?.textContent.trim() || '';
        let type = 'Item';
        let description = '';

        if (sectionHeader.includes('Applications')) {
            type = 'Application';
            // Get install state from badge
            const badge = row.querySelector('.badge');
            description = badge ? `Status: ${badge.textContent.trim()}` : 'Installation issue';
        } else if (sectionHeader.includes('Configuration Profiles')) {
            type = 'Configuration Profile';
            const badge = row.querySelector('.badge');
            description = badge ? `Deployment: ${badge.textContent.trim()}` : 'Deployment issue';
        } else if (sectionHeader.includes('Compliance')) {
            type = 'Compliance Policy';
            const badge = row.querySelector('.badge');
            description = badge ? `State: ${badge.textContent.trim()}` : 'Compliance issue';
        }

        // Get row ID for jump link
        const rowId = row.dataset.id || row.id || null;

        const issue = {
            name: name,
            type: type,
            description: description,
            targetId: rowId,
            category: category
        };

        if (category === 'error') {
            issues.critical.push(issue);
        } else if (category === 'warning') {
            issues.warnings.push(issue);
        }
    });

    return issues;
}

// Comprehensive Device Overview Dashboard Functions
function calculateComprehensiveMetrics() {
    const metrics = {
        // Device identity
        device: {
            hostname: policyData.deviceInfo?.hostname || 'Unknown',
            os: policyData.deviceInfo?.os?.name || 'Unknown',
            osVersion: policyData.deviceInfo?.os?.version || '',
            osBuild: policyData.deviceInfo?.os?.build || '',
            serial: policyData.deviceInfo?.serialNumber || 'Unknown',
            joinType: policyData.deviceInfo?.joinType || 'Unknown',
            managementType: policyData.deviceInfo?.managementType || 'Unknown',
            tenantId: policyData.intune?.tenantId || 'N/A',
            lastSync: policyData.intune?.lastSync || 'Never',
            collectionTime: policyData.metadata?.collectionTime || 'Unknown'
        },

        // Health & status
        health: {
            overall: 'good', // calculated below
            overallColor: 'success',
            complianceStatus: 'Unknown',
            complianceColor: 'neutral',
            issuesCount: 0,
            issuesColor: 'success',
            updatesPending: 0,
            updateSource: 'Unknown'
        },

        // Configuration categories
        groupPolicy: { total: 0, errors: 0, warnings: 0, success: 0 },
        intuneProfiles: { total: 0, errors: 0, warnings: 0, success: 0 },
        intuneApps: { total: 0, errors: 0, warnings: 0, success: 0 },
        compliance: { total: 0, errors: 0, warnings: 0, success: 0 },
        sccmBaselines: { total: 0, errors: 0, warnings: 0, success: 0 },
        sccmApps: { total: 0, errors: 0, warnings: 0, success: 0 },
        sccmUpdates: { total: 0, errors: 0, warnings: 0, success: 0 },
        windowsUpdate: { total: 0, pending: 0, failed: 0, installed: 0 }
    };

    // Count items from all sections
    document.querySelectorAll('table tbody > tr[data-status-category]').forEach(row => {
        const category = row.dataset.statusCategory;
        const section = row.closest('.section');
        const sectionId = section ? section.id : '';

        // Group Policy
        if (sectionId === 'gp-computer-section') {
            metrics.groupPolicy.total++;
            if (category === 'error') metrics.groupPolicy.errors++;
            else if (category === 'warning') metrics.groupPolicy.warnings++;
            else if (category === 'success') metrics.groupPolicy.success++;
        }
        // Intune Profiles
        else if (sectionId === 'intune-profiles-section') {
            metrics.intuneProfiles.total++;
            if (category === 'error') metrics.intuneProfiles.errors++;
            else if (category === 'warning') metrics.intuneProfiles.warnings++;
            else if (category === 'success') metrics.intuneProfiles.success++;
        }
        // Intune Apps
        else if (sectionId === 'intune-apps-section') {
            metrics.intuneApps.total++;
            if (category === 'error') metrics.intuneApps.errors++;
            else if (category === 'warning') metrics.intuneApps.warnings++;
            else if (category === 'success') metrics.intuneApps.success++;
        }
        // Compliance
        else if (sectionId === 'intune-compliance-section') {
            metrics.compliance.total++;
            if (category === 'error') metrics.compliance.errors++;
            else if (category === 'warning') metrics.compliance.warnings++;
            else if (category === 'success') metrics.compliance.success++;
        }
        // SCCM Baselines
        else if (sectionId === 'sccm-baselines-section') {
            metrics.sccmBaselines.total++;
            if (category === 'error') metrics.sccmBaselines.errors++;
            else if (category === 'warning') metrics.sccmBaselines.warnings++;
            else if (category === 'success') metrics.sccmBaselines.success++;
        }
        // SCCM Apps
        else if (sectionId === 'sccm-apps-section') {
            metrics.sccmApps.total++;
            if (category === 'error') metrics.sccmApps.errors++;
            else if (category === 'warning') metrics.sccmApps.warnings++;
            else if (category === 'success') metrics.sccmApps.success++;
        }
        // SCCM Updates
        else if (sectionId === 'sccm-updates-section') {
            metrics.sccmUpdates.total++;
            if (category === 'error') metrics.sccmUpdates.errors++;
            else if (category === 'warning') metrics.sccmUpdates.warnings++;
            else if (category === 'success') metrics.sccmUpdates.success++;
        }
    });

    // Windows Update data
    if (policyData.windowsUpdate?.summary) {
        metrics.windowsUpdate.pending = policyData.windowsUpdate.summary.pendingCount || 0;
        metrics.windowsUpdate.total = metrics.windowsUpdate.pending;
        metrics.health.updatesPending = metrics.windowsUpdate.pending;
        metrics.health.updateSource = policyData.windowsUpdate.summary.updateManagement || 'Unknown';
    }

    // Collection issues
    if (policyData.collectionIssues) {
        metrics.health.issuesCount = policyData.collectionIssues.length;
        const hasErrors = policyData.collectionIssues.some(i => i.severity === 'Error');
        const hasWarnings = policyData.collectionIssues.some(i => i.severity === 'Warning');
        if (hasErrors) metrics.health.issuesColor = 'error';
        else if (hasWarnings) metrics.health.issuesColor = 'warning';
    }

    // Compliance status
    if (policyData.intune?.compliancePolicies) {
        const policies = policyData.intune.compliancePolicies;
        const hasNonCompliant = policies.some(p => p.state && p.state.match(/nonCompliant|error/i));
        if (hasNonCompliant) {
            metrics.health.complianceStatus = 'Non-Compliant';
            metrics.health.complianceColor = 'error';
        } else if (policies.length > 0) {
            metrics.health.complianceStatus = 'Compliant';
            metrics.health.complianceColor = 'success';
        }
    }

    // Calculate overall health
    const totalErrors = metrics.groupPolicy.errors + metrics.intuneProfiles.errors +
                       metrics.intuneApps.errors + metrics.compliance.errors +
                       metrics.sccmBaselines.errors + metrics.sccmApps.errors + metrics.sccmUpdates.errors;
    const totalWarnings = metrics.groupPolicy.warnings + metrics.intuneProfiles.warnings +
                         metrics.intuneApps.warnings + metrics.compliance.warnings +
                         metrics.sccmBaselines.warnings + metrics.sccmApps.warnings + metrics.sccmUpdates.warnings;

    if (totalErrors > 0) {
        metrics.health.overall = 'critical';
        metrics.health.overallColor = 'error';
    } else if (totalWarnings > 0) {
        metrics.health.overall = 'warning';
        metrics.health.overallColor = 'warning';
    } else {
        metrics.health.overall = 'good';
        metrics.health.overallColor = 'success';
    }

    return metrics;
}

function renderDeviceOverviewDashboard() {
    const container = document.getElementById('executive-dashboard-container');
    if (!container) return;

    const m = calculateComprehensiveMetrics();

    const html = `
        <div class="device-overview-dashboard">
            <!-- Device Identity -->
            <div class="dashboard-section device-identity">
                <h2 class="dashboard-section-title">
                    <span class="section-icon">🧬</span>
                    Device DNA Report - ${m.device.hostname}
                </h2>
                <div class="identity-grid">
                    <div class="identity-item">
                        <label>Operating System</label>
                        <span>${m.device.os} ${m.device.osVersion}</span>
                        <small>Build ${m.device.osBuild}</small>
                    </div>
                    <div class="identity-item">
                        <label>Serial Number</label>
                        <span>${m.device.serial}</span>
                    </div>
                    <div class="identity-item">
                        <label>Join Type</label>
                        <span>${m.device.joinType}</span>
                    </div>
                    <div class="identity-item">
                        <label>Management</label>
                        <span>${m.device.managementType}</span>
                    </div>
                    <div class="identity-item">
                        <label>Tenant ID</label>
                        <span class="value-truncate">${m.device.tenantId}</span>
                    </div>
                    <div class="identity-item">
                        <label>Last Intune Sync</label>
                        <span>${m.device.lastSync}</span>
                    </div>
                    <div class="identity-item">
                        <label>Collection Time</label>
                        <span>${m.device.collectionTime}</span>
                    </div>
                </div>
            </div>

            <!-- Health & Status -->
            <div class="dashboard-section health-status">
                <h3 class="dashboard-subsection-title">Health & Status</h3>
                <div class="health-grid">
                    <div class="health-card status-${m.health.overallColor}">
                        <div class="health-icon">💚</div>
                        <div class="health-label">Overall Health</div>
                        <div class="health-value">${m.health.overall}</div>
                    </div>
                    <div class="health-card status-${m.health.complianceColor}">
                        <div class="health-icon">✓</div>
                        <div class="health-label">Compliance</div>
                        <div class="health-value">${m.health.complianceStatus}</div>
                    </div>
                    <div class="health-card status-${m.health.issuesColor}">
                        <div class="health-icon">⚠️</div>
                        <div class="health-label">Collection Issues</div>
                        <div class="health-value">${m.health.issuesCount}</div>
                    </div>
                    <div class="health-card status-${m.health.updatesPending > 0 ? 'warning' : 'success'}">
                        <div class="health-icon">🔄</div>
                        <div class="health-label">Updates Pending</div>
                        <div class="health-value">${m.health.updatesPending}</div>
                        <div class="health-source">Source: ${m.health.updateSource}</div>
                    </div>
                </div>
            </div>

            <!-- Configuration Summary -->
            <div class="dashboard-section config-summary">
                <h3 class="dashboard-subsection-title">Configuration Summary</h3>
                <div class="config-list">
                    ${renderConfigRow('📋', 'Group Policy', m.groupPolicy, 'gp')}
                    ${renderConfigRow('⚙️', 'Intune Profiles', m.intuneProfiles, 'intune')}
                    ${renderConfigRow('📦', 'Applications', {
                        total: m.intuneApps.total + m.sccmApps.total,
                        errors: m.intuneApps.errors + m.sccmApps.errors,
                        warnings: m.intuneApps.warnings + m.sccmApps.warnings,
                        success: m.intuneApps.success + m.sccmApps.success
                    }, 'intune')}
                    ${renderConfigRow('✓', 'Compliance Policies', m.compliance, 'intune')}
                    ${renderConfigRow('🛡️', 'SCCM Baselines', m.sccmBaselines, 'sccm')}
                    ${renderConfigRow('🔄', 'Windows Update', {
                        total: m.windowsUpdate.total,
                        errors: 0,
                        warnings: m.windowsUpdate.pending,
                        success: 0
                    }, 'wu')}
                </div>
            </div>
        </div>
    `;

    container.innerHTML = html;
}

function renderConfigRow(icon, title, metrics, tabId) {
    const total = metrics.total || 0;
    if (total === 0) return ''; // Don't show if no data

    const statusClass = metrics.errors > 0 ? 'error' : metrics.warnings > 0 ? 'warning' : 'success';

    return `
        <div class="config-row status-${statusClass}" data-tab="${tabId}" onclick="if(typeof switchTab === 'function') switchTab('${tabId}')">
            <div class="config-icon">${icon}</div>
            <div class="config-info">
                <div class="config-title">${title}</div>
                <div class="config-stats">
                    ${metrics.errors > 0 ? `<span class="stat-badge error">● ${metrics.errors} error${metrics.errors !== 1 ? 's' : ''}</span>` : ''}
                    ${metrics.warnings > 0 ? `<span class="stat-badge warning">● ${metrics.warnings} warning${metrics.warnings !== 1 ? 's' : ''}</span>` : ''}
                    ${metrics.success > 0 ? `<span class="stat-badge success">● ${metrics.success} applied</span>` : ''}
                </div>
            </div>
            <div class="config-total">${total}</div>
            <div class="config-arrow">›</div>
        </div>
    `;
}

function renderIssueSummary() {
    const container = document.getElementById('issue-summary-container');
    if (!container) return;

    const issues = buildIssueSummary();
    const totalIssues = issues.critical.length + issues.warnings.length;

    if (totalIssues === 0) {
        container.innerHTML = `
            <div class="issue-summary">
                <div class="issue-summary-header">
                    <h2>⚡ Issue Summary</h2>
                    <div class="summary-count">All systems operational</div>
                </div>
                <div class="issue-summary-body">
                    <div class="issue-empty-state">No issues found</div>
                </div>
            </div>
        `;
        return;
    }

    let html = `
        <div class="issue-summary">
            <div class="issue-summary-header">
                <h2>⚡ Issue Summary</h2>
                <div class="summary-count">Found ${issues.critical.length} critical issue${issues.critical.length !== 1 ? 's' : ''} and ${issues.warnings.length} warning${issues.warnings.length !== 1 ? 's' : ''}</div>
            </div>
            <div class="issue-summary-body">
    `;

    // Critical issues
    if (issues.critical.length > 0) {
        html += `
            <div class="issue-category">
                <div class="issue-category-header critical" onclick="toggleIssueCategory(this)">
                    <div class="issue-category-title">
                        <span class="icon">🔴</span>
                        <span>Critical Issues</span>
                        <span class="issue-category-count">${issues.critical.length}</span>
                    </div>
                    <span class="issue-category-toggle">▼</span>
                </div>
                <div class="issue-category-items">
        `;

        issues.critical.forEach(issue => {
            const jumpLink = issue.targetId ? `<a href="#" class="jump-link" onclick="jumpToIssue('${issue.targetId}'); return false;">View details</a>` : '';
            html += `
                <div class="issue-item">
                    <div class="issue-item-icon">🔴</div>
                    <div class="issue-item-content">
                        <div class="issue-item-name">${escapeHtml(issue.name)}</div>
                        <div class="issue-item-description">${issue.type} • ${escapeHtml(issue.description)}</div>
                    </div>
                    <div class="issue-item-action">${jumpLink}</div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    // Warnings
    if (issues.warnings.length > 0) {
        html += `
            <div class="issue-category">
                <div class="issue-category-header warning" onclick="toggleIssueCategory(this)">
                    <div class="issue-category-title">
                        <span class="icon">⚠️</span>
                        <span>Warnings</span>
                        <span class="issue-category-count">${issues.warnings.length}</span>
                    </div>
                    <span class="issue-category-toggle">▼</span>
                </div>
                <div class="issue-category-items">
        `;

        issues.warnings.forEach(issue => {
            const jumpLink = issue.targetId ? `<a href="#" class="jump-link" onclick="jumpToIssue('${issue.targetId}'); return false;">View details</a>` : '';
            html += `
                <div class="issue-item">
                    <div class="issue-item-icon">⚠️</div>
                    <div class="issue-item-content">
                        <div class="issue-item-name">${escapeHtml(issue.name)}</div>
                        <div class="issue-item-description">${issue.type} • ${escapeHtml(issue.description)}</div>
                    </div>
                    <div class="issue-item-action">${jumpLink}</div>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    }

    html += `
            </div>
        </div>
    `;

    container.innerHTML = html;
}

function toggleIssueCategory(header) {
    header.classList.toggle('collapsed');
}

function jumpToIssue(targetId) {
    const target = document.getElementById(targetId) || document.querySelector(`[data-id="${targetId}"]`);
    if (!target) return;

    // Switch to the correct tab if target is inside a tab panel
    const tabPanel = target.closest('.tab-panel');
    if (tabPanel && tabPanel.dataset.tab) {
        switchTab(tabPanel.dataset.tab);
    }

    // Expand parent section if collapsed
    const section = target.closest('.section');
    if (section) section.classList.remove('collapsed');

    // Small delay to let tab switch render, then scroll
    setTimeout(() => {
        target.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Expand if it's an expandable row
        if (target.classList.contains('expandable-row') && !target.classList.contains('expanded')) {
            target.click();
        }

        // Highlight effect
        target.style.transition = 'background-color 0.3s ease';
        const originalBg = target.style.backgroundColor;
        target.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
        setTimeout(() => {
            target.style.backgroundColor = originalBg;
        }, 2000);
    }, 100);
}

// =============================================================================
// TAB NAVIGATION SYSTEM
// =============================================================================

const TAB_CONFIG = {
    overview: {
        label: 'Overview',
        icon: '\u{1F4CA}',
        sections: ['executive-dashboard-container', 'issue-summary-container', 'collection-issues-section']
    },
    gp: {
        label: 'Group Policy',
        icon: '\u{1F4BB}',
        sections: ['gp-computer-section']
    },
    intune: {
        label: 'Intune',
        icon: '\u2699\uFE0F',
        sections: ['intune-groups-device-section', 'intune-profiles-section', 'intune-apps-section', 'intune-compliance-section', 'intune-scripts-section']
    },
    sccm: {
        label: 'SCCM',
        icon: '\u2699',
        sections: ['sccm-client-section', 'sccm-apps-section', 'sccm-baselines-section', 'sccm-updates-section', 'sccm-settings-section']
    },
    wu: {
        label: 'Windows Updates',
        icon: '\u{1F504}',
        sections: ['wu-summary-section', 'wu-policy-section', 'wu-pending-section', 'wu-history-section']
    },
    device: {
        label: 'Device',
        icon: '\u{1F4F1}',
        sections: ['device-info-section']
    }
};

let activeTab = 'overview';

function initializeTabs() {
    const tabBar = document.querySelector('.tab-bar');
    if (!tabBar) return;

    // Click handlers for tab buttons
    tabBar.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            if (tabId) switchTab(tabId);
        });
    });

    // Keyboard navigation (arrow keys within tab bar)
    tabBar.addEventListener('keydown', (e) => {
        const tabs = Array.from(tabBar.querySelectorAll('.tab-btn'));
        const current = tabs.findIndex(t => t.classList.contains('active'));
        let next = -1;

        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            next = (current + 1) % tabs.length;
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            next = (current - 1 + tabs.length) % tabs.length;
        } else if (e.key === 'Home') {
            next = 0;
        } else if (e.key === 'End') {
            next = tabs.length - 1;
        }

        if (next >= 0) {
            e.preventDefault();
            tabs[next].focus();
            switchTab(tabs[next].dataset.tab);
        }
    });

    // Mobile tab select handler
    const mobileSelect = document.getElementById('tab-mobile-select');
    if (mobileSelect) {
        mobileSelect.addEventListener('change', (e) => {
            switchTab(e.target.value);
        });
    }

    // Determine initial tab from URL hash or localStorage
    const initialTab = getInitialTab();
    switchTab(initialTab, false);

    // Update badge counts after data is loaded
    updateTabBadges();
}

function switchTab(tabId, updateHistory) {
    if (!TAB_CONFIG[tabId]) return;
    if (updateHistory === undefined) updateHistory = true;

    activeTab = tabId;

    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const isActive = btn.dataset.tab === tabId;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive);
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
    });

    // Show/hide tab panels
    document.querySelectorAll('.tab-panel').forEach(panel => {
        const isActive = panel.dataset.tab === tabId;
        panel.classList.toggle('active', isActive);
        panel.classList.toggle('visible', isActive);
        panel.hidden = !isActive;
    });

    // Update mobile select
    const mobileSelect = document.getElementById('tab-mobile-select');
    if (mobileSelect) mobileSelect.value = tabId;

    // Persist to URL hash and localStorage
    if (updateHistory) {
        history.replaceState(null, '', '#' + tabId);
    }
    try { localStorage.setItem('devicedna-active-tab', tabId); } catch(e) {}

    // Scroll to top of content area
    const container = document.querySelector('.container');
    if (container && updateHistory) {
        window.scrollTo({ top: container.offsetTop - 60, behavior: 'smooth' });
    }
}

function getInitialTab() {
    // Check URL hash first
    const hash = window.location.hash.replace('#', '');
    if (hash && TAB_CONFIG[hash]) return hash;

    // Then localStorage
    try {
        const saved = localStorage.getItem('devicedna-active-tab');
        if (saved && TAB_CONFIG[saved]) return saved;
    } catch(e) {}

    return 'overview';
}

function updateTabBadges() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const tabId = btn.dataset.tab;
        const config = TAB_CONFIG[tabId];
        if (!config) return;

        let totalItems = 0;
        let hasIssues = false;

        config.sections.forEach(sectionId => {
            const section = document.getElementById(sectionId);
            if (!section) return;

            // Count table rows (scope to main table only, not nested sub-tables)
            const mainTable = section.querySelector('.table-container > table');
            if (mainTable) {
                const mainTbody = mainTable.querySelector('tbody');
                if (mainTbody) {
                    const rows = mainTbody.querySelectorAll(':scope > tr:not(.detail-row)');
                    totalItems += rows.length;
                }
            }

            // Check for error/warning status
            const errorRows = section.querySelectorAll('tr[data-status-category="error"]');
            const warningRows = section.querySelectorAll('tr[data-status-category="warning"]');
            if (errorRows.length > 0 || warningRows.length > 0) hasIssues = true;

            // Check for collection issues (overview tab)
            const alerts = section.querySelectorAll('.alert-danger, .alert-warning');
            if (alerts.length > 0) hasIssues = true;
        });

        // Update badge
        const badge = btn.querySelector('.tab-badge');
        if (badge && totalItems > 0) {
            badge.textContent = totalItems;
            badge.style.display = '';
        } else if (badge) {
            badge.style.display = 'none';
        }

        // Update status dot
        const dot = btn.querySelector('.tab-status-dot');
        if (dot) {
            dot.className = 'tab-status-dot' + (hasIssues ? ' has-issues' : '');
        }
    });
}


// =============================================================================
// SUMMARY STRIPS
// =============================================================================

function renderSummaryStrips() {
    // Find all table containers with data-section attributes that have status-categorized rows
    document.querySelectorAll('.table-container[data-section]').forEach(container => {
        const rows = container.querySelectorAll('tbody > tr[data-status-category]');
        if (rows.length === 0) return;

        // Count statuses
        let counts = { error: 0, warning: 0, success: 0, neutral: 0 };
        rows.forEach(row => {
            const cat = row.dataset.statusCategory || 'neutral';
            if (counts[cat] !== undefined) counts[cat]++;
        });

        const total = rows.length;

        // Build the strip
        const strip = document.createElement('div');
        strip.className = 'summary-strip';

        let statsHtml = '';
        if (counts.error > 0) {
            statsHtml += '<span class="summary-strip-stat"><span class="summary-strip-dot danger"></span>' + counts.error + ' Error' + (counts.error !== 1 ? 's' : '') + '</span>';
        }
        if (counts.warning > 0) {
            statsHtml += '<span class="summary-strip-stat"><span class="summary-strip-dot warning"></span>' + counts.warning + ' Warning' + (counts.warning !== 1 ? 's' : '') + '</span>';
        }
        if (counts.success > 0) {
            statsHtml += '<span class="summary-strip-stat"><span class="summary-strip-dot success"></span>' + counts.success + ' OK</span>';
        }
        if (counts.neutral > 0) {
            statsHtml += '<span class="summary-strip-stat"><span class="summary-strip-dot neutral"></span>' + counts.neutral + ' N/A</span>';
        }

        // Build progress bar segments
        let progressHtml = '<div class="progress-bar progress-bar-sm">';
        if (total > 0) {
            if (counts.success > 0) progressHtml += '<div class="progress-bar-segment success" style="width:' + (counts.success / total * 100) + '%"></div>';
            if (counts.warning > 0) progressHtml += '<div class="progress-bar-segment warning" style="width:' + (counts.warning / total * 100) + '%"></div>';
            if (counts.error > 0) progressHtml += '<div class="progress-bar-segment danger" style="width:' + (counts.error / total * 100) + '%"></div>';
            if (counts.neutral > 0) progressHtml += '<div class="progress-bar-segment neutral" style="width:' + (counts.neutral / total * 100) + '%"></div>';
        }
        progressHtml += '</div>';

        strip.innerHTML =
            '<div class="summary-strip-total"><span class="count">' + total + '</span> total</div>' +
            '<div class="summary-strip-stats">' + statsHtml + '</div>' +
            '<div class="summary-strip-progress">' + progressHtml + '</div>';

        // Insert before the table
        const table = container.querySelector('table');
        if (table) {
            container.insertBefore(strip, table);
        }
    });
}

// DeviceDNA Intune Rendering Functions
// Handles client-side rendering of all Intune sections

/**
 * Helper function to get status category from status string
 * Maps status values to categories: error, warning, success, neutral
 */
function getStatusCategory(status) {
    const statusLower = (status || '').toLowerCase();

    if (statusLower.match(/denied|error|non-compliant|noncompliant|failed/)) {
        return 'error';
    } else if (statusLower.match(/warning|pending|conflict/)) {
        return 'warning';
    } else if (statusLower.match(/applied|compliant|targeted|installed|succeeded|success/)) {
        return 'success';
    } else {
        return 'neutral';
    }
}

/**
 * Helper function to generate status icon HTML
 */
function getStatusIcon(statusCategory) {
    switch (statusCategory) {
        case 'error':
            return '<span class="status-icon error" aria-label="Error">●</span>';
        case 'warning':
            return '<span class="status-icon warning" aria-label="Warning">●</span>';
        case 'success':
            return '<span class="status-icon success" aria-label="Success">●</span>';
        default:
            return '<span class="status-icon neutral" aria-label="Not applicable">●</span>';
    }
}

/**
 * Helper function to generate status badge HTML
 */
function getIntuneStatusBadge(status) {
    const statusLower = (status || '').toLowerCase();
    let badgeClass = 'badge-muted';

    if (statusLower.match(/applied|compliant|targeted|installed|succeeded|success/)) {
        badgeClass = 'badge-success';
    } else if (statusLower.match(/warning|pending/)) {
        badgeClass = 'badge-warning';
    } else if (statusLower.match(/denied|error|non-compliant|noncompliant|failed/)) {
        badgeClass = 'badge-danger';
    } else if (statusLower.match(/conflict/)) {
        badgeClass = 'badge-warning';
    } else if (statusLower.match(/not\s*applicable|notapplicable|n\/a|unknown/)) {
        badgeClass = 'badge-muted';
    } else if (statusLower.match(/info/)) {
        badgeClass = 'badge-info';
    }

    return `<span class="badge ${badgeClass}">${escapeHtml(status || 'Unknown')}</span>`;
}

/**
 * Helper function to generate group type badge HTML
 */
function getGroupTypeBadge(groupType) {
    const groupTypeLower = (groupType || 'Assigned').toLowerCase();
    const badgeClass = groupTypeLower === 'dynamic' ? 'badge-info' : 'badge-success';
    return `<span class="badge ${badgeClass}">${escapeHtml(groupType || 'Assigned')}</span>`;
}

/**
 * Render Entra ID Device Groups table
 * Simple table with no status icons - just group data
 */
function renderDeviceGroups(data) {
    if (!data || !data.deviceGroups || data.deviceGroups.length === 0) {
        return { html: '', count: 0 };
    }

    const groups = data.deviceGroups.sort((a, b) => {
        const aName = (a.displayName || a.name || '').toLowerCase();
        const bName = (b.displayName || b.name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';
    groups.forEach(group => {
        const name = escapeHtml(group.displayName || group.name || 'Unknown');
        const typeBadge = getGroupTypeBadge(group.groupType || 'Assigned');
        const id = escapeHtml(group.id || '');

        html += `
            <tr>
                <td>${name}</td>
                <td>${typeBadge}</td>
                <td class="value-truncate">${id}</td>
            </tr>
        `;
    });

    return { html, count: groups.length };
}

/**
 * Render Configuration Profiles table with expandable settings rows
 * CRITICAL: Includes expandable detail rows showing configured settings
 */
function renderConfigurationProfiles(data) {
    if (!data || !data.configurationProfiles || data.configurationProfiles.length === 0) {
        return { html: '', count: 0 };
    }

    const profiles = data.configurationProfiles.sort((a, b) => {
        const aName = (a.displayName || a.name || '').toLowerCase();
        const bName = (b.displayName || b.name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';
    let profileRowId = 0;

    profiles.forEach(profile => {
        const name = escapeHtml(profile.displayName || profile.name || 'Unknown');
        const description = profile.description
            ? escapeHtml(profile.description)
            : '<span class="text-muted">NONE</span>';
        const type = escapeHtml(profile.policyType || 'Unknown');
        const deploymentState = profile.deploymentState || 'Unknown';
        const deploymentBadge = getIntuneStatusBadge(deploymentState);

        // Get status category and icon
        const statusCategory = getStatusCategory(deploymentState);
        const statusIcon = getStatusIcon(statusCategory);

        // Show first matched group + count in table
        let assignedVia = '<span class="text-muted">Unknown</span>';
        if (profile.targetingStatus) {
            const groups = profile.targetingStatus.split(', ');
            const firstGroup = escapeHtml(groups[0]);
            if (groups.length > 1) {
                const additionalCount = groups.length - 1;
                assignedVia = `${firstGroup} <span class="text-muted">(+${additionalCount} more)</span>`;
            } else {
                assignedVia = firstGroup;
            }
        }

        // Settings count badge and expandable row logic
        const hasSettings = profile.settings && profile.settings.length > 0;
        let settingsCountBadge = '';
        let expandableClass = '';
        let dataIdAttr = '';
        let ariaAttr = '';

        if (hasSettings) {
            settingsCountBadge = ` <span class="settings-count">(${profile.settings.length} settings)</span>`;
            expandableClass = ' expandable-row';
            dataIdAttr = ` data-id="profile-${profileRowId}"`;
            ariaAttr = ' aria-expanded="false"';
        }

        // Main row
        html += `
            <tr class="${statusCategory}${expandableClass}" data-status-category="${statusCategory}"${dataIdAttr}${ariaAttr}>
                <td class="status-icon-cell">${statusIcon}</td>
                <td>${name}${settingsCountBadge}</td>
                <td>${description}</td>
                <td>${type}</td>
                <td>${deploymentBadge}</td>
                <td>${assignedVia}</td>
            </tr>
        `;

        // Build expandable detail row with settings sub-table
        if (hasSettings) {
            let settingsRowsHtml = '';
            profile.settings.forEach(setting => {
                const settingName = escapeHtml(setting.name || 'Unknown');
                let settingValue = escapeHtml(String(setting.value || ''));

                // Truncate long values
                if (settingValue.length > 200) {
                    const truncated = settingValue.substring(0, 200);
                    settingValue = `${truncated}<span class="text-muted">... (truncated)</span>`;
                }

                settingsRowsHtml += `
                    <tr>
                        <td>${settingName}</td>
                        <td class="setting-value">${settingValue}</td>
                    </tr>
                `;
            });

            html += `
            <tr id="detail-profile-${profileRowId}" class="detail-row">
                <td colspan="6">
                    <div class="detail-content">
                        <h4>Configured Settings</h4>
                        <table class="settings-table">
                            <thead>
                                <tr>
                                    <th>Setting</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${settingsRowsHtml}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            `;
        }

        profileRowId++;
    });

    return { html, count: profiles.length };
}

/**
 * Render Compliance Policies table
 */
function renderCompliancePolicies(data) {
    if (!data || !data.compliancePolicies || data.compliancePolicies.length === 0) {
        return { html: '', count: 0 };
    }

    const policies = data.compliancePolicies.sort((a, b) => {
        const aName = (a.displayName || a.name || '').toLowerCase();
        const bName = (b.displayName || b.name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    policies.forEach(policy => {
        const name = escapeHtml(policy.displayName || policy.name || 'Unknown');
        const platform = escapeHtml(policy.platform || 'Unknown');

        // Show first matched group + count in table
        let assignedVia = '<span class="text-muted">Unknown</span>';
        if (policy.targetingStatus) {
            const groups = policy.targetingStatus.split(', ');
            const firstGroup = escapeHtml(groups[0]);
            if (groups.length > 1) {
                const additionalCount = groups.length - 1;
                assignedVia = `${firstGroup} <span class="text-muted">(+${additionalCount} more)</span>`;
            } else {
                assignedVia = firstGroup;
            }
        }

        const complianceState = policy.complianceState || 'Unknown';
        const complianceBadge = getIntuneStatusBadge(complianceState);

        // Get status category and icon
        const statusCategory = getStatusCategory(complianceState);
        const statusIcon = getStatusIcon(statusCategory);

        html += `
            <tr data-status-category="${statusCategory}">
                <td class="status-icon-cell">${statusIcon}</td>
                <td>${name}</td>
                <td>${platform}</td>
                <td>${assignedVia}</td>
                <td>${complianceBadge}</td>
            </tr>
        `;
    });

    return { html, count: policies.length };
}

/**
 * Render Applications table
 */
function renderApplications(data) {
    if (!data || !data.applications || data.applications.length === 0) {
        return { html: '', count: 0 };
    }

    const apps = data.applications.sort((a, b) => {
        const aName = (a.displayName || a.name || '').toLowerCase();
        const bName = (b.displayName || b.name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    apps.forEach(app => {
        const name = escapeHtml(app.displayName || app.name || 'Unknown');

        // Version handling
        let version = '<span class="text-muted">N/A</span>';
        if (app.appVersion) {
            version = escapeHtml(app.appVersion);
        } else if (app.version) {
            version = escapeHtml(app.version);
        }

        const type = escapeHtml(app.appType || 'Unknown');
        const publisher = escapeHtml(app.publisher || 'Unknown');

        // Intent badge with color coding
        let intentBadge = '<span class="badge badge-secondary">Unknown</span>';
        if (app.intent === 'Required') {
            intentBadge = '<span class="badge badge-danger">Required</span>';
        } else if (app.intent === 'Available') {
            intentBadge = '<span class="badge badge-info">Available</span>';
        } else if (app.intent === 'Uninstall') {
            intentBadge = '<span class="badge badge-warning">Uninstall</span>';
        } else if (app.intent) {
            intentBadge = `<span class="badge badge-secondary">${escapeHtml(app.intent)}</span>`;
        }

        // Show assigned groups
        const assignedVia = app.targetingStatus
            ? escapeHtml(app.targetingStatus)
            : '<span class="text-muted">Unknown</span>';

        // Install state badge with color coding
        // Note: appInstallState is populated from local IME registry (Win32 apps only)
        let installState = 'Unknown';
        if (app.appInstallState) {
            installState = app.appInstallState;
        } else if (app.installedOnDevice === true) {
            installState = 'Installed';
        }

        let installedBadge = '';
        if (installState === 'Installed') {
            installedBadge = '<span class="badge badge-success">Installed</span>';
        } else if (installState === 'Not Installed') {
            installedBadge = '<span class="badge badge-secondary">Not Installed</span>';
        } else if (installState === 'Failed') {
            installedBadge = '<span class="badge badge-danger">Failed</span>';
        } else if (installState === 'Install Pending' || installState === 'Installing') {
            installedBadge = '<span class="badge badge-info">Install Pending</span>';
        } else if (installState === 'Not Applicable') {
            installedBadge = '<span class="badge badge-secondary text-muted">Not Applicable</span>';
        } else if (installState === 'Excluded') {
            installedBadge = '<span class="badge badge-warning">Excluded</span>';
        } else if (installState === 'Unknown') {
            installedBadge = '<span class="badge badge-warning">Unknown</span>';
        } else {
            installedBadge = `<span class="badge badge-secondary">${escapeHtml(installState)}</span>`;
        }

        // Get status category for data attribute and icon
        const statusCategory = getStatusCategory(installState);
        const statusIcon = getStatusIcon(statusCategory);

        html += `
            <tr data-status-category="${statusCategory}">
                <td class="status-icon-cell">${statusIcon}</td>
                <td>${name}</td>
                <td>${version}</td>
                <td>${publisher}</td>
                <td>${type}</td>
                <td>${intentBadge}</td>
                <td>${installedBadge}</td>
                <td>${assignedVia}</td>
            </tr>
        `;
    });

    return { html, count: apps.length };
}

/**
 * Render Proactive Remediations table
 */
function renderProactiveRemediations(data) {
    if (!data || !data.proactiveRemediations || data.proactiveRemediations.length === 0) {
        return { html: '', count: 0 };
    }

    const remediations = data.proactiveRemediations.sort((a, b) => {
        const aName = (a.displayName || '').toLowerCase();
        const bName = (b.displayName || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    remediations.forEach(remediation => {
        const name = escapeHtml(remediation.displayName || 'Unknown');
        const runAs = escapeHtml(remediation.runAsAccount || 'N/A');
        const targetingStatus = remediation.targetingStatus || 'Unknown';
        const statusBadge = getIntuneStatusBadge(targetingStatus);

        // Device run state details
        let detectionState = 'N/A';
        let remediationState = 'N/A';
        let lastRun = 'N/A';

        if (remediation.deviceRunState) {
            detectionState = remediation.deviceRunState.detectionState || 'N/A';
            remediationState = remediation.deviceRunState.remediationState || 'N/A';
            lastRun = remediation.deviceRunState.lastStateUpdateDateTime || 'N/A';
        }

        const detectionBadge = getIntuneStatusBadge(detectionState);
        const remediationBadge = getIntuneStatusBadge(remediationState);

        html += `
            <tr>
                <td>${name}</td>
                <td>${runAs}</td>
                <td>${detectionBadge}</td>
                <td>${remediationBadge}</td>
                <td>${escapeHtml(lastRun)}</td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });

    return { html, count: remediations.length };
}

/**
 * Main function to render all Intune sections
 * Call this from the main initialization to populate the template
 */
function renderAllIntuneSections(intuneData) {
    console.log('[DEBUG] renderAllIntuneSections called with:', intuneData);
    if (!intuneData) {
        console.log('[DEBUG] No Intune data, returning');
        return;
    }

    // Render Device Groups
    const deviceGroupsResult = renderDeviceGroups(intuneData);
    const deviceGroupsContainer = document.querySelector('#intune-groups-device-section .section-content');
    if (deviceGroupsContainer) {
        deviceGroupsContainer.innerHTML = '<table><thead><tr><th>Group Name</th><th>Type</th><th>Group ID</th></tr></thead><tbody>' + deviceGroupsResult.html + '</tbody></table>';
        updateSectionCount('intune-groups-device-section', deviceGroupsResult.count);
    }

    // Render Configuration Profiles
    const configProfilesResult = renderConfigurationProfiles(intuneData);
    const configProfilesContainer = document.querySelector('#config-profiles-section .section-content');
    if (configProfilesContainer) {
        configProfilesContainer.innerHTML = '<table><thead><tr><th></th><th>Name</th><th>Description</th><th>Type</th><th>Status</th><th>Assigned Via</th></tr></thead><tbody>' + configProfilesResult.html + '</tbody></table>';
        updateSectionCount('config-profiles-section', configProfilesResult.count);
    }

    // Render Compliance Policies
    const complianceResult = renderCompliancePolicies(intuneData);
    const complianceContainer = document.querySelector('#compliance-policies-section .section-content');
    if (complianceContainer) {
        complianceContainer.innerHTML = '<table><thead><tr><th></th><th>Name</th><th>Description</th><th>Platform</th><th>Status</th><th>Assigned Via</th></tr></thead><tbody>' + complianceResult.html + '</tbody></table>';
        updateSectionCount('compliance-policies-section', complianceResult.count);
    }

    // Render Applications
    const appsResult = renderApplications(intuneData);
    const appsContainer = document.querySelector('#applications-section .section-content');
    if (appsContainer) {
        appsContainer.innerHTML = '<table><thead><tr><th></th><th>Name</th><th>Publisher</th><th>Type</th><th>Status</th><th>Assigned Via</th></tr></thead><tbody>' + appsResult.html + '</tbody></table>';
        updateSectionCount('applications-section', appsResult.count);
    }

    // Render Proactive Remediations
    const remediationsResult = renderProactiveRemediations(intuneData);
    const remediationsContainer = document.querySelector('#remediations-section .section-content');
    if (remediationsContainer) {
        remediationsContainer.innerHTML = '<table><thead><tr><th></th><th>Name</th><th>Description</th><th>Status</th><th>Last Run</th><th>Assigned Via</th></tr></thead><tbody>' + remediationsResult.html + '</tbody></table>';
        updateSectionCount('remediations-section', remediationsResult.count);
    }

    // Re-initialize table functionality for newly rendered content
    if (typeof initializeTables === 'function') {
        initializeTables();
    }
    if (typeof initializeTableEnhancements === 'function') {
        initializeTableEnhancements();
    }
}

/**
 * Helper to update section count badges
 */
function updateSectionCount(sectionId, count) {
    const section = document.getElementById(sectionId);
    if (!section) return;

    const countBadge = section.querySelector('.section-count');
    if (countBadge) {
        countBadge.textContent = count;
    }

    // Update navigation count if exists
    const navLink = document.querySelector(`[data-section="${sectionId}"] .nav-link-count`);
    if (navLink) {
        if (count > 0) {
            navLink.textContent = count;
            navLink.style.display = '';
        } else {
            navLink.style.display = 'none';
        }
    }
}
// DeviceDNA Other Sections Rendering Functions
// Handles client-side rendering of Group Policy, SCCM, and Windows Update sections

/**
 * Helper function to get status category from status string
 * Maps status values to categories: error, warning, success, neutral
 */
function getOtherStatusCategory(status) {
    const statusLower = (status || '').toLowerCase();

    if (statusLower.match(/denied|error|non-compliant|noncompliant|failed/)) {
        return 'error';
    } else if (statusLower.match(/warning|pending|conflict/)) {
        return 'warning';
    } else if (statusLower.match(/applied|compliant|targeted|installed|succeeded|success|installcomplete/)) {
        return 'success';
    } else {
        return 'neutral';
    }
}

/**
 * Helper function to generate status icon HTML
 */
function getOtherStatusIcon(statusCategory) {
    switch (statusCategory) {
        case 'error':
            return '<span class="status-icon error" aria-label="Error">●</span>';
        case 'warning':
            return '<span class="status-icon warning" aria-label="Warning">●</span>';
        case 'success':
            return '<span class="status-icon success" aria-label="Success">●</span>';
        default:
            return '<span class="status-icon neutral" aria-label="Not applicable">●</span>';
    }
}

/**
 * Helper function to generate status badge HTML for other sections
 */
function getOtherStatusBadge(status) {
    const statusLower = (status || '').toLowerCase();
    let badgeClass = 'badge-muted';

    if (statusLower.match(/applied|compliant|installed|succeeded|success|installcomplete/)) {
        badgeClass = 'badge-success';
    } else if (statusLower.match(/warning|pending/)) {
        badgeClass = 'badge-warning';
    } else if (statusLower.match(/denied|error|failed/)) {
        badgeClass = 'badge-danger';
    } else if (statusLower.match(/conflict/)) {
        badgeClass = 'badge-warning';
    } else if (statusLower.match(/not\s*applicable|notapplicable|n\/a|unknown|available|none/)) {
        badgeClass = 'badge-muted';
    } else if (statusLower.match(/info|download|install/)) {
        badgeClass = 'badge-info';
    }

    return `<span class="badge ${badgeClass}">${escapeHtml(status || 'Unknown')}</span>`;
}

/**
 * Helper function to update section count badge
 */
function updateOtherSectionCount(sectionId, count) {
    const section = document.getElementById(sectionId);
    if (!section) return;

    const countBadge = section.querySelector('.section-count');
    if (countBadge) {
        countBadge.textContent = count;
    }

    // Update navigation count if exists
    const navLink = document.querySelector(`[data-section="${sectionId}"] .nav-link-count`);
    if (navLink) {
        if (count > 0) {
            navLink.textContent = count;
            navLink.style.display = '';
        } else {
            navLink.style.display = 'none';
        }
    }
}

// ============================================================================
// GROUP POLICY FUNCTIONS
// ============================================================================

/**
 * Render Group Policy Objects table
 * Shows GPO metadata without status icons
 */
function renderGroupPolicyObjects(data, scope) {
    if (!data || !data.groupPolicy || !data.groupPolicy[scope] || !data.groupPolicy[scope].appliedGPOs) {
        return { html: '', count: 0 };
    }

    const gpos = data.groupPolicy[scope].appliedGPOs.sort((a, b) => {
        const aName = (a.name || '').toLowerCase();
        const bName = (b.name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';
    let rowId = 0;

    gpos.forEach(gpo => {
        const name = escapeHtml(gpo.name || 'Unknown');
        const link = escapeHtml(gpo.linkLocation || '');
        const status = gpo.status || 'Applied';
        const statusBadge = getOtherStatusBadge(status);

        html += `
            <tr class="expandable-row" data-id="${scope}-gpo-${rowId}" aria-expanded="false">
                <td>${name}</td>
                <td>${link}</td>
                <td>${statusBadge}</td>
            </tr>
            <tr id="detail-${scope}-gpo-${rowId}" class="detail-row">
                <td colspan="3">
                    <div class="detail-content">
                        <h4>GPO Settings</h4>
                        <p class="text-muted">Settings details would appear here when available.</p>
                    </div>
                </td>
            </tr>
        `;
        rowId++;
    });

    return { html, count: gpos.length };
}

/**
 * Render Group Policy Settings table
 * This can be a LARGE table (1000+ rows), so pagination is recommended
 * Note: Pagination logic is handled by existing table search/filter infrastructure
 */
function renderGroupPolicySettings(data) {
    if (!data || !data.groupPolicy || !data.groupPolicy.settings || data.groupPolicy.settings.length === 0) {
        return { html: '', count: 0 };
    }

    const settings = data.groupPolicy.settings.sort((a, b) => {
        const aName = (a.name || '').toLowerCase();
        const bName = (b.name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    settings.forEach(setting => {
        const name = escapeHtml(setting.name || 'Unknown');
        const value = escapeHtml(String(setting.value || ''));
        const sourceGPO = escapeHtml(setting.sourceGPO || 'Unknown');
        const keyPath = escapeHtml(setting.keyPath || '');

        html += `
            <tr>
                <td>${name}</td>
                <td class="setting-value">${value}</td>
                <td>${sourceGPO}</td>
                <td class="value-truncate">${keyPath}</td>
            </tr>
        `;
    });

    return { html, count: settings.length };
}

// ============================================================================
// SCCM FUNCTIONS
// ============================================================================

/**
 * Render SCCM Applications table
 * Includes status icons for install state tracking
 */
function renderSCCMApplications(data) {
    if (!data || !data.sccm || !data.sccm.applications || data.sccm.applications.length === 0) {
        return { html: '', count: 0 };
    }

    const apps = data.sccm.applications.sort((a, b) => {
        const aName = (a.Name || '').toLowerCase();
        const bName = (b.Name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    apps.forEach(app => {
        const name = escapeHtml(app.Name || 'Unknown');
        const version = escapeHtml(app.Version || '');
        const publisher = escapeHtml(app.Publisher || '');
        const installState = app.InstallState || 'Unknown';
        const evalState = app.EvaluationState || 'Unknown';

        // Install state badge
        const installBadge = getOtherStatusBadge(installState);

        // Evaluation state badge
        let evalBadge;
        if (evalState === 'InstallComplete') {
            evalBadge = '<span class="badge badge-success">Installed</span>';
        } else if (evalState.match(/Error/)) {
            evalBadge = '<span class="badge badge-danger">Error</span>';
        } else if (evalState.match(/Install|Download/)) {
            evalBadge = `<span class="badge badge-info">${escapeHtml(evalState)}</span>`;
        } else if (evalState === 'Available' || evalState === 'None') {
            evalBadge = `<span class="badge badge-muted">${escapeHtml(evalState)}</span>`;
        } else {
            evalBadge = `<span class="badge badge-secondary">${escapeHtml(evalState)}</span>`;
        }

        // Required badge
        const requiredBadge = app.IsRequired
            ? '<span class="badge badge-danger">Required</span>'
            : '<span class="badge badge-info">Available</span>';

        // Status category for row filtering
        const statusCategory = getOtherStatusCategory(installState);
        const statusIcon = getOtherStatusIcon(statusCategory);

        html += `
            <tr data-status-category="${statusCategory}">
                <td class="status-icon-cell">${statusIcon}</td>
                <td>${name}</td>
                <td>${version}</td>
                <td>${publisher}</td>
                <td>${requiredBadge}</td>
                <td>${installBadge}</td>
                <td>${evalBadge}</td>
            </tr>
        `;
    });

    return { html, count: apps.length };
}

/**
 * Render SCCM Compliance Baselines table
 * Includes status icons for compliance state tracking
 */
function renderSCCMBaselines(data) {
    if (!data || !data.sccm || !data.sccm.baselines || data.sccm.baselines.length === 0) {
        return { html: '', count: 0 };
    }

    const baselines = data.sccm.baselines.sort((a, b) => {
        const aName = (a.Name || '').toLowerCase();
        const bName = (b.Name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    baselines.forEach(baseline => {
        const name = escapeHtml(baseline.Name || 'Unknown');
        const version = escapeHtml(baseline.Version || '');
        const complianceState = baseline.ComplianceState || 'Unknown';
        const lastEval = escapeHtml(baseline.LastEvaluated || 'N/A');

        const complianceBadge = getOtherStatusBadge(complianceState);

        const statusCategory = getOtherStatusCategory(complianceState);
        const statusIcon = getOtherStatusIcon(statusCategory);

        html += `
            <tr data-status-category="${statusCategory}">
                <td class="status-icon-cell">${statusIcon}</td>
                <td>${name}</td>
                <td>${version}</td>
                <td>${complianceBadge}</td>
                <td>${lastEval}</td>
            </tr>
        `;
    });

    return { html, count: baselines.length };
}

/**
 * Render SCCM Software Updates table
 * Includes status icons for update installation tracking
 */
function renderSCCMUpdates(data) {
    if (!data || !data.sccm || !data.sccm.softwareUpdates || data.sccm.softwareUpdates.length === 0) {
        return { html: '', count: 0 };
    }

    const updates = data.sccm.softwareUpdates.sort((a, b) => {
        const aName = (a.Name || '').toLowerCase();
        const bName = (b.Name || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    updates.forEach(update => {
        const articleId = escapeHtml(update.ArticleID || '');
        const name = escapeHtml(update.Name || 'Unknown');
        const evalState = update.EvaluationState || 'Unknown';
        const deadline = escapeHtml(update.Deadline || 'N/A');

        // Evaluation state badge
        let evalBadge;
        if (evalState === 'InstallComplete') {
            evalBadge = '<span class="badge badge-success">Installed</span>';
        } else if (evalState.match(/Error/)) {
            evalBadge = '<span class="badge badge-danger">Error</span>';
        } else if (evalState.match(/Install|Download/)) {
            evalBadge = `<span class="badge badge-info">${escapeHtml(evalState)}</span>`;
        } else {
            evalBadge = `<span class="badge badge-secondary">${escapeHtml(evalState)}</span>`;
        }

        // Required badge
        const requiredBadge = update.IsRequired
            ? '<span class="badge badge-danger">Required</span>'
            : '<span class="badge badge-muted">Not Required</span>';

        // Status category
        let statusCategory;
        if (evalState.match(/Error/)) {
            statusCategory = 'error';
        } else if (evalState.match(/Install|Download|Pending/)) {
            statusCategory = 'warning';
        } else if (evalState === 'InstallComplete') {
            statusCategory = 'success';
        } else {
            statusCategory = 'neutral';
        }

        const statusIcon = getOtherStatusIcon(statusCategory);

        html += `
            <tr data-status-category="${statusCategory}">
                <td class="status-icon-cell">${statusIcon}</td>
                <td>${articleId}</td>
                <td>${name}</td>
                <td>${evalBadge}</td>
                <td>${requiredBadge}</td>
                <td>${deadline}</td>
            </tr>
        `;
    });

    return { html, count: updates.length };
}

/**
 * Render SCCM Client Settings
 * Grouped by policy category with expandable key-value pairs
 */
function renderSCCMSettings(data) {
    if (!data || !data.sccm || !data.sccm.clientSettings || data.sccm.clientSettings.length === 0) {
        return { html: '', count: 0 };
    }

    const categories = data.sccm.clientSettings.sort((a, b) => {
        const aName = (a.Category || '').toLowerCase();
        const bName = (b.Category || '').toLowerCase();
        return aName.localeCompare(bName);
    });

    let html = '';

    categories.forEach(category => {
        const catName = escapeHtml(category.Category || 'Unknown');
        let settingsRows = '';

        if (category.Settings) {
            const sortedKeys = Object.keys(category.Settings).sort();
            sortedKeys.forEach(key => {
                const val = category.Settings[key];
                const valStr = val === null || val === undefined ? 'N/A' : String(val);
                settingsRows += `
                    <div class="info-row">
                        <span class="info-label">${escapeHtml(key)}</span>
                        <span class="info-value">${escapeHtml(valStr)}</span>
                    </div>
                `;
            });
        }

        html += `
            <div class="info-group">
                <h3>${catName}</h3>
                ${settingsRows}
            </div>
        `;
    });

    return { html, count: categories.length };
}

// ============================================================================
// WINDOWS UPDATE FUNCTIONS
// ============================================================================

/**
 * Render Windows Update Summary
 * Summary grid with "Managed By" badge (SCCM/Intune WUFB/Intune ESUS/WSUS/Direct)
 */
function renderWUSummary(data) {
    if (!data || !data.windowsUpdate || !data.windowsUpdate.summary) {
        return { html: '', count: 0 };
    }

    const wuSum = data.windowsUpdate.summary;

    // Reboot badge
    const rebootBadge = wuSum.rebootPending
        ? '<span class="badge badge-warning">Reboot Pending</span>'
        : '<span class="badge badge-success">No Reboot Pending</span>';

    // Service state badge
    let svcBadge;
    if (wuSum.serviceState === 'Running') {
        svcBadge = '<span class="badge badge-success">Running</span>';
    } else if (wuSum.serviceState === 'Stopped') {
        svcBadge = '<span class="badge badge-muted">Stopped</span>';
    } else {
        svcBadge = `<span class="badge badge-secondary">${escapeHtml(wuSum.serviceState || 'Unknown')}</span>`;
    }

    // Pending updates badge
    const pendingBadge = wuSum.pendingCount > 0
        ? `<span class="badge badge-warning">${wuSum.pendingCount} Pending</span>`
        : '<span class="badge badge-success">0 Pending</span>';

    // Delivery Optimization mode
    let doModeStr = 'Not configured (default)';
    if (data.windowsUpdate.deliveryOptimization && data.windowsUpdate.deliveryOptimization.DODownloadMode) {
        doModeStr = data.windowsUpdate.deliveryOptimization.DODownloadMode.Decoded || 'Unknown';
    }

    // Build management badge for prominent display
    // Color-coded: Blue=SCCM, Green=Intune, Gray=WSUS/Direct
    let mgmtBadge = '<span class="badge badge-secondary">Unknown</span>';
    const mgmtText = wuSum.updateManagement || 'None';

    if (mgmtText.match(/SCCM/)) {
        mgmtBadge = '<span class="badge badge-info">SCCM</span>';
    } else if (mgmtText.match(/Intune.*WUFB/)) {
        mgmtBadge = '<span class="badge badge-success">Intune (WUFB)</span>';
    } else if (mgmtText.match(/Intune.*ESUS/)) {
        mgmtBadge = '<span class="badge badge-success">Intune (ESUS)</span>';
    } else if (mgmtText.match(/WSUS/)) {
        mgmtBadge = '<span class="badge badge-muted">WSUS</span>';
    } else if (mgmtText === 'None') {
        mgmtBadge = '<span class="badge badge-muted">Windows Update (direct)</span>';
    }

    const html = `
        <div class="device-info-grid">
            <div class="info-group">
                <h3>Update Management</h3>
                <div class="info-row"><span class="info-label">Managed By</span><span class="info-value">${mgmtBadge}</span></div>
                <div class="info-row"><span class="info-label">Update Source</span><span class="info-value">${escapeHtml(wuSum.updateSource || 'Unknown')}</span></div>
                <div class="info-row"><span class="info-label">Source Priority</span><span class="info-value">${escapeHtml(wuSum.sourcePriority || 'Unknown')}</span></div>
            </div>
            <div class="info-group">
                <h3>Service Status</h3>
                <div class="info-row"><span class="info-label">Service State</span><span class="info-value">${svcBadge}</span></div>
                <div class="info-row"><span class="info-label">Reboot Status</span><span class="info-value">${rebootBadge}</span></div>
                <div class="info-row"><span class="info-label">Pending Updates</span><span class="info-value">${pendingBadge}</span></div>
            </div>
            <div class="info-group">
                <h3>Scan History</h3>
                <div class="info-row"><span class="info-label">Last Scan Time</span><span class="info-value">${escapeHtml(wuSum.lastScanTime || 'Unknown')}</span></div>
                <div class="info-row"><span class="info-label">Last Scan Success</span><span class="info-value">${escapeHtml(wuSum.lastScanSuccess || 'Unknown')}</span></div>
            </div>
            <div class="info-group">
                <h3>Delivery Optimization</h3>
                <div class="info-row"><span class="info-label">Download Mode</span><span class="info-value">${escapeHtml(doModeStr)}</span></div>
            </div>
        </div>
    `;

    return { html, count: 1 };
}

/**
 * Render Windows Update Policy Settings table
 * Registry hive sources grouped by hive name
 */
function renderWUPolicy(data) {
    if (!data || !data.windowsUpdate || !data.windowsUpdate.registryPolicy || Object.keys(data.windowsUpdate.registryPolicy).length === 0) {
        return { html: '', count: 0 };
    }

    // Group by hive name
    const hiveGroups = {};
    Object.entries(data.windowsUpdate.registryPolicy).forEach(([key, entry]) => {
        const hiveName = entry.Hive || 'Unknown';
        if (!hiveGroups[hiveName]) {
            hiveGroups[hiveName] = [];
        }
        hiveGroups[hiveName].push(entry);
    });

    let html = '';
    let totalCount = 0;
    const sortedHives = Object.keys(hiveGroups).sort();

    sortedHives.forEach(hiveName => {
        html += `<tr class="group-header-row"><td colspan="3"><strong>${escapeHtml(hiveName)}</strong></td></tr>\n`;

        const sortedSettings = hiveGroups[hiveName].sort((a, b) => {
            const aName = (a.Setting || '').toLowerCase();
            const bName = (b.Setting || '').toLowerCase();
            return aName.localeCompare(bName);
        });

        sortedSettings.forEach(setting => {
            const knownMarker = setting.Known ? '' : ' <span class="badge badge-muted">Extra</span>';
            const descHtml = setting.Description
                ? `<br><span class="setting-desc">${escapeHtml(setting.Description)}</span>`
                : '';

            html += `
                <tr>
                    <td>${escapeHtml(setting.Setting || '')}${knownMarker}${descHtml}</td>
                    <td>${escapeHtml(String(setting.Value || ''))}</td>
                    <td>${escapeHtml(setting.Decoded || '')}</td>
                </tr>
            `;
            totalCount++;
        });
    });

    return { html, count: totalCount };
}

/**
 * Render Windows Update Pending Updates table
 * Shows updates awaiting installation
 */
function renderWUPending(data) {
    if (!data || !data.windowsUpdate || !data.windowsUpdate.pendingUpdates || data.windowsUpdate.pendingUpdates.length === 0) {
        return { html: '', count: 0 };
    }

    const updates = data.windowsUpdate.pendingUpdates;
    let html = '';

    updates.forEach(update => {
        const title = escapeHtml(update.Title || 'Unknown');
        const kb = escapeHtml(update.KBArticleIDs || '');
        const severity = update.MsrcSeverity || 'Unspecified';

        // Severity badge
        let severityBadge;
        if (severity === 'Critical') {
            severityBadge = '<span class="badge badge-danger">Critical</span>';
        } else if (severity === 'Important') {
            severityBadge = '<span class="badge badge-warning">Important</span>';
        } else if (severity === 'Moderate') {
            severityBadge = '<span class="badge badge-info">Moderate</span>';
        } else {
            severityBadge = `<span class="badge badge-muted">${escapeHtml(severity)}</span>`;
        }

        // Download badge
        const dlBadge = update.IsDownloaded
            ? '<span class="badge badge-success">Downloaded</span>'
            : '<span class="badge badge-muted">Not Downloaded</span>';

        html += `
            <tr data-status-category="warning">
                <td class="status-icon-cell"><span class="status-icon warning" aria-label="Pending">●</span></td>
                <td>${title}</td>
                <td>${kb}</td>
                <td>${severityBadge}</td>
                <td>${dlBadge}</td>
            </tr>
        `;
    });

    return { html, count: updates.length };
}

/**
 * Render Windows Update History table
 * Shows past update installation attempts
 */
function renderWUHistory(data) {
    if (!data || !data.windowsUpdate || !data.windowsUpdate.updateHistory || data.windowsUpdate.updateHistory.length === 0) {
        return { html: '', count: 0 };
    }

    const history = data.windowsUpdate.updateHistory;
    let html = '';

    history.forEach(entry => {
        const title = escapeHtml(entry.Title || 'Unknown');
        const date = escapeHtml(entry.Date || 'N/A');
        const op = escapeHtml(entry.Operation || 'Unknown');
        const result = entry.Result || 'Unknown';
        const hResult = entry.HResult ? escapeHtml(entry.HResult) : '';

        // Status category
        let statusCategory;
        if (result.match(/Succeeded/)) {
            statusCategory = 'success';
        } else if (result === 'Failed') {
            statusCategory = 'error';
        } else if (result === 'Aborted') {
            statusCategory = 'warning';
        } else {
            statusCategory = 'neutral';
        }

        const statusIcon = getOtherStatusIcon(statusCategory);
        const resultBadge = getOtherStatusBadge(result);

        html += `
            <tr data-status-category="${statusCategory}">
                <td class="status-icon-cell">${statusIcon}</td>
                <td>${title}</td>
                <td>${date}</td>
                <td>${op}</td>
                <td>${resultBadge}</td>
                <td>${hResult}</td>
            </tr>
        `;
    });

    return { html, count: history.length };
}

// ============================================================================
// ORCHESTRATION FUNCTION
// ============================================================================

/**
 * Render all non-Intune sections (Group Policy, SCCM, Windows Update)
 * Call this after data is loaded to populate the report
 */
function renderAllOtherSections(data) {
    console.log('[DEBUG] renderAllOtherSections called with:', data);
    if (!data) {
        console.log('[DEBUG] No data, returning');
        return;
    }

    // Group Policy - Computer Scope
    if (data.groupPolicy && data.groupPolicy.computerScope) {
        const computerGPOsResult = renderGroupPolicyObjects(data, 'computerScope');
        const computerGPOsContainer = document.querySelector('#gp-objects-section .section-content');
        if (computerGPOsContainer && computerGPOsResult.html) {
            computerGPOsContainer.innerHTML = '<table><thead><tr><th>GPO Name</th><th>Link Location</th><th>Status</th></tr></thead><tbody>' + computerGPOsResult.html + '</tbody></table>';
            updateOtherSectionCount('gp-objects-section', computerGPOsResult.count);
        }
    }

    // Group Policy - User Scope (not currently in JSON structure)
    if (data.groupPolicy && data.groupPolicy.userScope) {
        const userGPOsResult = renderGroupPolicyObjects(data, 'userScope');
        const userGPOsContainer = document.querySelector('#gp-user-section .section-content');
        if (userGPOsContainer && userGPOsResult.html) {
            userGPOsContainer.innerHTML = '<table><tbody>' + userGPOsResult.html + '</tbody></table>';
            updateOtherSectionCount('gp-user-section', userGPOsResult.count);
        }
    }

    // SCCM - Applications
    const sccmAppsResult = renderSCCMApplications(data);
    const sccmAppsContainer = document.querySelector('#sccm-apps-section .section-content');
    if (sccmAppsContainer && sccmAppsResult.html) {
        sccmAppsContainer.innerHTML = '<table><thead><tr><th>Name</th><th>Version</th><th>Status</th></tr></thead><tbody>' + sccmAppsResult.html + '</tbody></table>';
        updateOtherSectionCount('sccm-apps-section', sccmAppsResult.count);
    }

    // SCCM - Baselines
    const sccmBaselinesResult = renderSCCMBaselines(data);
    const sccmBaselinesContainer = document.querySelector('#sccm-baselines-section .section-content');
    if (sccmBaselinesContainer && sccmBaselinesResult.html) {
        sccmBaselinesContainer.innerHTML = '<table><thead><tr><th>Name</th><th>Version</th><th>Status</th></tr></thead><tbody>' + sccmBaselinesResult.html + '</tbody></table>';
        updateOtherSectionCount('sccm-baselines-section', sccmBaselinesResult.count);
    }

    // SCCM - Updates
    const sccmUpdatesResult = renderSCCMUpdates(data);
    const sccmUpdatesContainer = document.querySelector('#sccm-updates-section .section-content');
    if (sccmUpdatesContainer && sccmUpdatesResult.html) {
        sccmUpdatesContainer.innerHTML = '<table><thead><tr><th>Title</th><th>Status</th><th>Required</th></tr></thead><tbody>' + sccmUpdatesResult.html + '</tbody></table>';
        updateOtherSectionCount('sccm-updates-section', sccmUpdatesResult.count);
    }

    // SCCM - Client Settings
    const sccmSettingsResult = renderSCCMSettings(data);
    const sccmSettingsSection = document.getElementById('sccm-settings-section');
    if (sccmSettingsSection) {
        const container = sccmSettingsSection.querySelector('.device-info-grid');
        if (container && sccmSettingsResult.html) {
            container.innerHTML = sccmSettingsResult.html;
            updateOtherSectionCount('sccm-settings-section', sccmSettingsResult.count);
        }
    }

    // Windows Update - Summary
    const wuSummaryResult = renderWUSummary(data);
    const wuSummarySection = document.getElementById('wu-summary-section');
    if (wuSummarySection) {
        const container = wuSummarySection.querySelector('.section-content');
        if (container && wuSummaryResult.html) {
            container.innerHTML = wuSummaryResult.html;
        }
    }

    // Windows Update - Policy
    const wuPolicyResult = renderWUPolicy(data);
    const wuPolicyContainer = document.querySelector('#wu-policy-section .section-content');
    if (wuPolicyContainer && wuPolicyResult.html) {
        wuPolicyContainer.innerHTML = '<div class="device-info-grid">' + wuPolicyResult.html + '</div>';
    }

    // Windows Update - Pending Updates
    const wuPendingResult = renderWUPending(data);
    const wuPendingContainer = document.querySelector('#wu-pending-section .section-content');
    if (wuPendingContainer && wuPendingResult.html) {
        wuPendingContainer.innerHTML = '<table><thead><tr><th>Title</th><th>KB</th><th>Classification</th></tr></thead><tbody>' + wuPendingResult.html + '</tbody></table>';
        updateOtherSectionCount('wu-pending-section', wuPendingResult.count);
    }

    // Windows Update - History
    const wuHistoryResult = renderWUHistory(data);
    const wuHistoryContainer = document.querySelector('#wu-history-section .section-content');
    if (wuHistoryContainer && wuHistoryResult.html) {
        wuHistoryContainer.innerHTML = '<table><thead><tr><th>Title</th><th>KB</th><th>Date</th><th>Status</th></tr></thead><tbody>' + wuHistoryResult.html + '</tbody></table>';
        updateOtherSectionCount('wu-history-section', wuHistoryResult.count);
    }

    // Update all status counts after rendering
    if (typeof updateAllStatusCounts === 'function') {
        updateAllStatusCounts();
    }
}
// =============================================================================
// OVERVIEW TAB & DEVICE TAB RENDER FUNCTIONS
// =============================================================================
// This module contains JavaScript render functions for the Overview and Device
// tabs in the DeviceDNA report template.
//
// NOTE: renderExecutiveDashboard() and renderIssueSummary() are already
// implemented in the main JavaScript. This file documents their structure and
// provides the renderCollectionIssues() and renderDeviceInfo() functions.
//
// Dependencies:
// - Global deviceData object (parsed from embedded JSON)
// - escapeHtml() utility function
// - updateSectionCount() utility function (if available)
// =============================================================================

// =============================================================================
// OVERVIEW TAB FUNCTIONS
// =============================================================================

/**
 * Renders the executive dashboard in the Overview tab
 * ALREADY IMPLEMENTED in extracted-javascript.js as renderDeviceOverviewDashboard()
 *
 * This function:
 * - Calculates comprehensive metrics via calculateComprehensiveMetrics()
 * - Renders device identity section (hostname, OS, serial, join type, etc.)
 * - Renders health & status cards (overall health, compliance, issues, updates)
 * - Renders configuration summary with clickable rows for each domain
 * - Populates #executive-dashboard-container
 *
 * @param {Object} data - Global deviceData object
 */
function renderExecutiveDashboard(data) {
    // This function is already implemented as renderDeviceOverviewDashboard()
    // in the main JavaScript (extracted-javascript.js)
    // See lines 4387-4488 in Reporting.ps1

    if (typeof renderDeviceOverviewDashboard === 'function') {
        renderDeviceOverviewDashboard();
    }
}

/**
 * Renders the issue summary panel in the Overview tab
 * ALREADY IMPLEMENTED in extracted-javascript.js as renderIssueSummary()
 *
 * This function:
 * - Calls buildIssueSummary() to aggregate errors and warnings
 * - Groups issues by severity (critical errors, warnings)
 * - Shows affected items with jump links to sections
 * - Displays "All systems operational" if no issues
 * - Populates #issue-summary-container
 *
 * @param {Object} data - Global deviceData object
 */
function renderIssueSummaryPanel(data) {
    // This function is already implemented as renderIssueSummary()
    // in the main JavaScript (extracted-javascript.js)
    // See lines 4513-4620 in Reporting.ps1

    if (typeof renderIssueSummary === 'function') {
        renderIssueSummary();
    }
}

/**
 * Renders the collection issues section in the Overview tab
 * Shows problems that occurred during data collection
 *
 * @param {Object} data - Global deviceData object
 */
function renderCollectionIssues(data) {
    const container = document.getElementById('collection-issues');
    if (!container) return;

    const issues = data.collectionIssues || [];
    if (!issues || issues.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">✔️</div><p>No issues detected during collection</p></div>';
        return;
    }

    // Filter out irrelevant issues based on management type
    const mgmtType = (data.deviceInfo?.managementType || '').toLowerCase();
    const filtered = issues.filter(issue => {
        const phase = (issue.phase || '').toLowerCase();

        // Cloud-only: suppress GP-related info/warnings (no AD)
        if (mgmtType === 'cloud-only' || mgmtType === 'azure ad joined') {
            if (phase === 'group policy' && issue.severity !== 'Error') return false;
        }

        // On-prem only: suppress Intune-related info/warnings
        if (mgmtType.startsWith('on-prem')) {
            if ((phase === 'intune' || phase === 'local intune') && issue.severity !== 'Error') return false;
        }

        return true;
    });

    if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">✔️</div><p>No relevant issues detected</p></div>';
        return;
    }

    // Icon and class mapping
    const iconMap = {
        'Error': '❌',
        'Warning': '⚠️',
        'Info': 'ℹ️'
    };
    const classMap = {
        'Error': 'alert-danger',
        'Warning': 'alert-warning',
        'Info': 'alert-info'
    };

    let html = '';
    filtered.forEach(issue => {
        const icon = iconMap[issue.severity] || 'ℹ️';
        const alertClass = classMap[issue.severity] || 'alert-info';

        html += `
            <div class="alert ${alertClass}">
                <span class="alert-icon">${icon}</span>
                <div>
                    <strong>${escapeHtml(issue.phase)}</strong>: ${escapeHtml(issue.message)}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;

    // Update section count
    const section = container.closest('.section');
    if (section) {
        const countSpan = section.querySelector('.section-count');
        if (countSpan) {
            countSpan.textContent = filtered.length;
        }
    }
}

/**
 * Orchestration function: Renders all sections in the Overview tab
 * @param {Object} data - Global deviceData object
 */
function renderOverviewTab(data) {
    renderExecutiveDashboard(data);
    renderIssueSummaryPanel(data);
    renderCollectionIssues(data);
}

// =============================================================================
// DEVICE TAB FUNCTIONS
// =============================================================================

/**
 * Renders the complete device information section in the Device tab
 * Displays hardware, OS, network, security, and power information
 *
 * NOTE: The PowerShell implementation generates nested tables with <h3> headers.
 * This JavaScript version mirrors that structure.
 *
 * @param {Object} data - Global deviceData object
 */
function renderDeviceInfo(data) {
    const container = document.getElementById('device-info-content');
    if (!container) {
        // Try alternate container
        const section = document.getElementById('device-info-section');
        if (!section) return;

        const content = section.querySelector('.section-content');
        if (!content) return;

        // Use section content as container
        renderDeviceInventoryInContainer(content, data);
        return;
    }

    renderDeviceInventoryInContainer(container, data);
}

/**
 * Helper function to render device inventory into a specific container
 * @param {HTMLElement} container - Target container element
 * @param {Object} data - Global deviceData object
 */
function renderDeviceInventoryInContainer(container, data) {
    const deviceInfo = data.deviceInfo || {};
    let html = '';

    // ==========================================================================
    // PROCESSOR
    // ==========================================================================
    if (deviceInfo.Processor) {
        const proc = deviceInfo.Processor;
        html += '<h3>Processor</h3>';
        html += '<table class="nested-table"><tbody>';
        html += `<tr><td><strong>Name</strong></td><td>${escapeHtml(proc.Name || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Manufacturer</strong></td><td>${escapeHtml(proc.Manufacturer || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Cores</strong></td><td>${escapeHtml(proc.Cores || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Logical Processors</strong></td><td>${escapeHtml(proc.LogicalProcessors || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Max Clock Speed</strong></td><td>${escapeHtml(proc.MaxClockSpeed || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Architecture</strong></td><td>${escapeHtml(proc.Architecture || 'N/A')}</td></tr>`;
        html += '</tbody></table>';
    }

    // ==========================================================================
    // MEMORY
    // ==========================================================================
    if (deviceInfo.Memory) {
        const mem = deviceInfo.Memory;
        html += '<h3>Memory</h3>';
        html += '<table class="nested-table"><tbody>';
        html += `<tr><td><strong>Total Physical Memory</strong></td><td>${escapeHtml(mem.TotalPhysicalMemory || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Available Memory</strong></td><td>${escapeHtml(mem.AvailableMemory || 'N/A')}</td></tr>`;

        // Memory modules sub-table
        if (mem.MemoryModules && mem.MemoryModules.length > 0) {
            html += '<tr><td><strong>Memory Modules</strong></td><td>';
            html += '<table class="nested-table"><thead><tr>';
            html += '<th scope="col">Capacity</th>';
            html += '<th scope="col">Speed</th>';
            html += '<th scope="col">Manufacturer</th>';
            html += '<th scope="col">Part Number</th>';
            html += '</tr></thead><tbody>';

            mem.MemoryModules.forEach(module => {
                html += '<tr>';
                html += `<td>${escapeHtml(module.Capacity || 'N/A')}</td>`;
                html += `<td>${escapeHtml(module.Speed || 'N/A')}</td>`;
                html += `<td>${escapeHtml(module.Manufacturer || 'N/A')}</td>`;
                html += `<td>${escapeHtml(module.PartNumber || 'N/A')}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '</td></tr>';
        }

        html += '</tbody></table>';
    }

    // ==========================================================================
    // STORAGE
    // ==========================================================================
    if (deviceInfo.Storage && deviceInfo.Storage.Disks && deviceInfo.Storage.Disks.length > 0) {
        html += '<h3>Storage</h3>';
        html += '<table class="nested-table"><thead><tr>';
        html += '<th scope="col">Model</th>';
        html += '<th scope="col">Size</th>';
        html += '<th scope="col">Interface</th>';
        html += '<th scope="col">Media Type</th>';
        html += '<th scope="col">Status</th>';
        html += '</tr></thead><tbody>';

        deviceInfo.Storage.Disks.forEach(disk => {
            html += '<tr>';
            html += `<td>${escapeHtml(disk.Model || 'N/A')}</td>`;
            html += `<td>${escapeHtml(disk.Size || 'N/A')}</td>`;
            html += `<td>${escapeHtml(disk.InterfaceType || 'N/A')}</td>`;
            html += `<td>${escapeHtml(disk.MediaType || 'N/A')}</td>`;
            html += `<td>${escapeHtml(disk.Status || 'N/A')}</td>`;
            html += '</tr>';
        });

        html += '</tbody></table>';
    }

    // ==========================================================================
    // BIOS / FIRMWARE
    // ==========================================================================
    if (deviceInfo.BIOS) {
        const bios = deviceInfo.BIOS;
        html += '<h3>BIOS / Firmware</h3>';
        html += '<table class="nested-table"><tbody>';
        html += `<tr><td><strong>Manufacturer</strong></td><td>${escapeHtml(bios.Manufacturer || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Version</strong></td><td>${escapeHtml(bios.Version || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Release Date</strong></td><td>${escapeHtml(bios.ReleaseDate || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>SMBIOS Version</strong></td><td>${escapeHtml(bios.SMBIOSVersion || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Boot Mode</strong></td><td>${escapeHtml(bios.UEFIMode || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Secure Boot</strong></td><td>${escapeHtml(bios.SecureBoot || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>TPM Present</strong></td><td>${escapeHtml(bios.TPMPresent || 'N/A')}</td></tr>`;

        if (bios.TPMVersion) {
            html += `<tr><td><strong>TPM Version</strong></td><td>${escapeHtml(bios.TPMVersion)}</td></tr>`;
            html += `<tr><td><strong>TPM Enabled</strong></td><td>${escapeHtml(bios.TPMEnabled || 'N/A')}</td></tr>`;
        }

        html += '</tbody></table>';
    }

    // ==========================================================================
    // NETWORK ADAPTERS
    // ==========================================================================
    if (deviceInfo.Network && deviceInfo.Network.Adapters && deviceInfo.Network.Adapters.length > 0) {
        html += '<h3>Network Adapters</h3>';

        deviceInfo.Network.Adapters.forEach(adapter => {
            const desc = escapeHtml(adapter.Description || 'Unknown Adapter');
            html += `<h4>${desc}</h4>`;
            html += '<table class="nested-table"><tbody>';
            html += `<tr><td><strong>MAC Address</strong></td><td>${escapeHtml(adapter.MACAddress || 'N/A')}</td></tr>`;
            html += `<tr><td><strong>IP Address</strong></td><td>${escapeHtml(adapter.IPAddress || 'N/A')}</td></tr>`;
            html += `<tr><td><strong>Subnet Mask</strong></td><td>${escapeHtml(adapter.SubnetMask || 'N/A')}</td></tr>`;
            html += `<tr><td><strong>Default Gateway</strong></td><td>${escapeHtml(adapter.DefaultGateway || 'N/A')}</td></tr>`;
            html += `<tr><td><strong>DHCP Enabled</strong></td><td>${escapeHtml(adapter.DHCPEnabled || 'N/A')}</td></tr>`;
            html += `<tr><td><strong>DHCP Server</strong></td><td>${escapeHtml(adapter.DHCPServer || 'N/A')}</td></tr>`;
            html += `<tr><td><strong>DNS Servers</strong></td><td>${escapeHtml(adapter.DNSServers || 'N/A')}</td></tr>`;
            html += `<tr><td><strong>DNS Domain</strong></td><td>${escapeHtml(adapter.DNSDomain || 'N/A')}</td></tr>`;
            html += '</tbody></table>';
        });
    }

    // ==========================================================================
    // PROXY CONFIGURATION
    // ==========================================================================
    if (deviceInfo.Proxy) {
        const proxy = deviceInfo.Proxy;
        html += '<h3>Proxy Configuration</h3>';
        html += '<table class="nested-table"><tbody>';
        html += `<tr><td><strong>Proxy Enabled</strong></td><td>${escapeHtml(proxy.ProxyEnable || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Proxy Server</strong></td><td>${escapeHtml(proxy.ProxyServer || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Proxy Override</strong></td><td>${escapeHtml(proxy.ProxyOverride || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Auto Config URL</strong></td><td>${escapeHtml(proxy.AutoConfigURL || 'N/A')}</td></tr>`;
        html += '</tbody></table>';
    }

    // ==========================================================================
    // SECURITY STATUS
    // ==========================================================================
    if (deviceInfo.Security) {
        const sec = deviceInfo.Security;
        html += '<h3>Security Status</h3>';

        // BitLocker Volumes
        if (sec.BitLockerVolumes && sec.BitLockerVolumes.length > 0) {
            html += '<h4>BitLocker Volumes</h4>';
            html += '<table class="nested-table"><thead><tr>';
            html += '<th scope="col">Mount Point</th>';
            html += '<th scope="col">Protection Status</th>';
            html += '<th scope="col">Encryption %</th>';
            html += '</tr></thead><tbody>';

            sec.BitLockerVolumes.forEach(vol => {
                html += '<tr>';
                html += `<td>${escapeHtml(vol.MountPoint || 'N/A')}</td>`;
                html += `<td>${escapeHtml(vol.ProtectionStatus || 'N/A')}</td>`;
                html += `<td>${escapeHtml(vol.EncryptionPercentage || 'N/A')}%</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
        }

        // Windows Defender
        if (sec.DefenderVersion) {
            html += '<h4>Windows Defender</h4>';
            html += '<table class="nested-table"><tbody>';
            html += `<tr><td><strong>Antimalware Version</strong></td><td>${escapeHtml(sec.DefenderVersion)}</td></tr>`;
            html += '</tbody></table>';
        }

        // Windows Firewall
        if (sec.FirewallStatus) {
            html += '<h4>Windows Firewall</h4>';
            html += '<table class="nested-table"><tbody>';

            for (const profile in sec.FirewallStatus) {
                const status = escapeHtml(sec.FirewallStatus[profile] || 'N/A');
                html += `<tr><td><strong>${profile} Profile</strong></td><td>${status}</td></tr>`;
            }

            html += '</tbody></table>';
        }
    }

    // ==========================================================================
    // POWER & UPTIME
    // ==========================================================================
    if (deviceInfo.Power) {
        const pwr = deviceInfo.Power;
        html += '<h3>Power & Uptime</h3>';
        html += '<table class="nested-table"><tbody>';
        html += `<tr><td><strong>Battery Present</strong></td><td>${escapeHtml(pwr.BatteryPresent || 'N/A')}</td></tr>`;

        if (pwr.BatteryStatus) {
            html += `<tr><td><strong>Battery Status</strong></td><td>${escapeHtml(pwr.BatteryStatus)}</td></tr>`;
            html += `<tr><td><strong>Battery Health</strong></td><td>${escapeHtml(pwr.BatteryHealth || 'N/A')}</td></tr>`;
        }

        html += `<tr><td><strong>Last Boot Time</strong></td><td>${escapeHtml(pwr.LastBootTime || 'N/A')}</td></tr>`;
        html += `<tr><td><strong>Uptime</strong></td><td>${escapeHtml(pwr.Uptime || 'N/A')}</td></tr>`;
        html += '</tbody></table>';
    }

    // ==========================================================================
    // FINALIZE
    // ==========================================================================
    if (html === '') {
        container.innerHTML = '<div class="empty-state"><p>No enhanced device inventory collected</p></div>';
    } else {
        container.innerHTML = html;
    }
}

/**
 * Orchestration function: Renders all sections in the Device tab
 * @param {Object} data - Global deviceData object
 */
function renderDeviceTab(data) {
    renderDeviceInfo(data);
}

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

/**
 * Escapes HTML to prevent XSS
 * NOTE: This should already exist in the main JavaScript, but included here
 * for completeness
 *
 * @param {string} text - Text to escape
 * @returns {string} HTML-safe text
 */
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    if (typeof text !== 'string') return String(text);

    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =============================================================================
// EXPORT FOR MODULE SYSTEMS (if needed)
// =============================================================================
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        renderOverviewTab,
        renderDeviceTab,
        renderExecutiveDashboard,
        renderIssueSummaryPanel,
        renderCollectionIssues,
        renderDeviceInfo
    };
}

// =============================================================================
// INITIALIZATION
// =============================================================================

// Note: deviceData and policyData are already declared globally above

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeTemplate();
});

function initializeTemplate() {
    console.log('[DEBUG] initializeTemplate called');
    updateLoadingStatus('Checking for data source...');

    // Check for URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const dataFile = urlParams.get('data');
    console.log('[DEBUG] URL data parameter:', dataFile);

    if (dataFile) {
        console.log('[DEBUG] Loading from URL parameter');
        loadDataFromFile(dataFile);
    } else {
        console.log('[DEBUG] No URL parameter, setting up file picker');
        setupFilePicker();
    }
}

function setupFilePicker() {
    console.log('[DEBUG] setupFilePicker called');
    const fileInput = document.getElementById('json-file-input');
    console.log('[DEBUG] fileInput element:', fileInput);
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
        console.log('[DEBUG] Event listener attached successfully');
    } else {
        console.error('[ERROR] File input element not found!');
    }
}

function updateLoadingStatus(message) {
    const statusEl = document.getElementById('loading-status');
    if (statusEl) {
        statusEl.textContent = message;
    }
}

function loadDataFromFile(filename) {
    updateLoadingStatus('Loading ' + filename + '...');

    fetch(filename)
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            updateLoadingStatus('Rendering report...');
            deviceData = data;
            policyData = data;
            renderReport();
            hideLoadingScreen();
        })
        .catch(error => {
            updateLoadingStatus('Failed to load: ' + error.message);
        });
}

function handleFileSelect(event) {
    console.log('[DEBUG] handleFileSelect called!', event);
    const file = event.target.files[0];
    console.log('[DEBUG] Selected file:', file);
    if (!file) {
        console.log('[DEBUG] No file selected, returning');
        return;
    }

    updateLoadingStatus('Loading ' + file.name + '...');
    console.log('[DEBUG] Starting FileReader...');

    const reader = new FileReader();
    reader.onload = function(e) {
        console.log('[DEBUG] FileReader onload fired');
        try {
            updateLoadingStatus('Parsing JSON...');
            console.log('[DEBUG] Parsing JSON...');
            deviceData = JSON.parse(e.target.result);
            policyData = deviceData;
            console.log('[DEBUG] JSON parsed successfully:', deviceData);

            updateLoadingStatus('Rendering report...');
            console.log('[DEBUG] Calling renderReport()');
            renderReport();
            console.log('[DEBUG] renderReport() completed');
            hideLoadingScreen();
        } catch (error) {
            console.error('[ERROR] JSON parse failed:', error);
            updateLoadingStatus('Failed to parse JSON: ' + error.message);
        }
    };

    reader.onerror = function() {
        updateLoadingStatus('Failed to read file. Please try again.');
    };

    reader.readAsText(file);
}

function hideLoadingScreen() {
    const loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
        loadingScreen.style.display = 'none';
    }
}

function renderReport() {
    if (!deviceData) {
        console.error('No data to render');
        return;
    }

    console.log('Rendering report with data:', deviceData);

    // Render header
    renderHeader();

    // Render Overview tab
    if (typeof renderOverviewTab === 'function') {
        renderOverviewTab(deviceData);
    }

    // Render all other sections
    if (typeof renderAllOtherSections === 'function') {
        renderAllOtherSections(deviceData);
    }

    // Render Intune sections
    if (typeof renderAllIntuneSections === 'function' && deviceData.intune) {
        renderAllIntuneSections(deviceData.intune);
    }

    // Render Device tab
    if (typeof renderDeviceTab === 'function') {
        renderDeviceTab(deviceData);
    }

    // Initialize interactive features
    if (typeof initializeReportFeatures === 'function') {
        initializeReportFeatures();
    } else {
        // Fallback initialization
        initializeStickyNav();
        initializeCollapsibles();
        initializeTables();
        initializeTableEnhancements();
        renderDeviceOverviewDashboard();
        renderIssueSummary();
        initializeSearch();
        initializeTheme();
        initializeExport();
        initializePrintHandlers();
        initializeTabs();
        renderSummaryStrips();
    }

    // Set generation time
    const genTimeEl = document.getElementById('generation-time');
    if (genTimeEl && deviceData.exportDate) {
        const date = new Date(deviceData.exportDate);
        genTimeEl.textContent = date.toLocaleString();
    }
}

function renderHeader() {
    const headerInfo = document.getElementById('header-info');
    if (!headerInfo || !deviceData.deviceInfo) return;

    const info = deviceData.deviceInfo;
    const metadata = deviceData.metadata || {};
    headerInfo.innerHTML =
        '<div class="header-info-item"><label>Device Name</label><span>' + escapeHtml(info.name || info.computerName || info.hostname || 'Unknown') + '</span></div>' +
        '<div class="header-info-item"><label>Operating System</label><span>' + escapeHtml(info.osName || '') + ' ' + escapeHtml(info.osVersion || '') + '</span></div>' +
        '<div class="header-info-item"><label>Serial Number</label><span>' + escapeHtml(info.serialNumber || 'N/A') + '</span></div>' +
        '<div class="header-info-item"><label>Join Type</label><span>' + escapeHtml(info.joinType || 'Unknown') + '</span></div>' +
        '<div class="header-info-item"><label>Management</label><span>' + escapeHtml(info.managementType || 'Unknown') + '</span></div>' +
        '<div class="header-info-item"><label>Tenant ID</label><span class="value-truncate">' + escapeHtml(info.tenantId || (deviceData.intune && deviceData.intune.tenantId) || 'N/A') + '</span></div>' +
        '<div class="header-info-item"><label>Collection Time</label><span>' + (metadata.collectionTime ? new Date(metadata.collectionTime).toLocaleString() : (deviceData.exportDate ? new Date(deviceData.exportDate).toLocaleString() : 'N/A')) + '</span></div>' +
        '<div class="header-info-item"><label>Last Intune Sync</label><span>' + ((deviceData.intune && deviceData.intune.managedDevice && deviceData.intune.managedDevice.lastSyncDateTime) ? new Date(deviceData.intune.managedDevice.lastSyncDateTime).toLocaleString() : 'N/A') + '</span></div>';
}

    </script>
</body>
</html>
